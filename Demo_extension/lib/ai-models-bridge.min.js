!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).AIModelsBridge={})}(this,(function(e){"use strict";var t;e.ErrorCode=void 0,(t=e.ErrorCode||(e.ErrorCode={})).UNKNOWN_ERROR="unknown_error",t.NETWORK_ERROR="network_error",t.UNAUTHORIZED="unauthorized",t.SERVICE_UNAVAILABLE="service_unavailable",t.MISSING_API_KEY="missing_api_key",t.MISSING_HOST_PERMISSION="missing_host_permission",t.CONVERSATION_LIMIT="conversation_limit",t.CONTENT_FILTERED="content_filtered",t.INVALID_REQUEST="invalid_request";class r extends Error{constructor(t,r=e.ErrorCode.UNKNOWN_ERROR){super(t),this.code=r,this.name="AIModelError"}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function s(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var n={exports:{}};!function(e){"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self&&self,function(e){if(!globalThis.chrome?.runtime?.id)throw new Error("This script should only be loaded in a browser extension.");if(void 0===globalThis.browser||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const t="The message port closed before a response was received.",r=e=>{const r={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(0===Object.keys(r).length)throw new Error("api-metadata.json has not been included in browser-polyfill");class s extends WeakMap{constructor(e,t=void 0){super(t),this.createItem=e}get(e){return this.has(e)||this.set(e,this.createItem(e)),super.get(e)}}const n=e=>e&&"object"==typeof e&&"function"==typeof e.then,o=(t,r)=>(...s)=>{e.runtime.lastError?t.reject(new Error(e.runtime.lastError.message)):r.singleCallbackArg||s.length<=1&&!1!==r.singleCallbackArg?t.resolve(s[0]):t.resolve(s)},a=e=>1==e?"argument":"arguments",i=(e,t)=>function(r,...s){if(s.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${a(t.minArgs)} for ${e}(), got ${s.length}`);if(s.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${a(t.maxArgs)} for ${e}(), got ${s.length}`);return new Promise(((n,a)=>{if(t.fallbackToNoCallback)try{r[e](...s,o({resolve:n,reject:a},t))}catch(o){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,o),r[e](...s),t.fallbackToNoCallback=!1,t.noCallback=!0,n()}else t.noCallback?(r[e](...s),n()):r[e](...s,o({resolve:n,reject:a},t))}))},c=(e,t,r)=>new Proxy(t,{apply:(t,s,n)=>r.call(s,e,...n)});let d=Function.call.bind(Object.prototype.hasOwnProperty);const g=(e,t={},r={})=>{let s=Object.create(null),n={has:(t,r)=>r in e||r in s,get(n,o,a){if(o in s)return s[o];if(!(o in e))return;let l=e[o];if("function"==typeof l)if("function"==typeof t[o])l=c(e,e[o],t[o]);else if(d(r,o)){let t=i(o,r[o]);l=c(e,e[o],t)}else l=l.bind(e);else if("object"==typeof l&&null!==l&&(d(t,o)||d(r,o)))l=g(l,t[o],r[o]);else{if(!d(r,"*"))return Object.defineProperty(s,o,{configurable:!0,enumerable:!0,get:()=>e[o],set(t){e[o]=t}}),l;l=g(l,t[o],r["*"])}return s[o]=l,l},set:(t,r,n,o)=>(r in s?s[r]=n:e[r]=n,!0),defineProperty:(e,t,r)=>Reflect.defineProperty(s,t,r),deleteProperty:(e,t)=>Reflect.deleteProperty(s,t)},o=Object.create(e);return new Proxy(o,n)},l=e=>({addListener(t,r,...s){t.addListener(e.get(r),...s)},hasListener:(t,r)=>t.hasListener(e.get(r)),removeListener(t,r){t.removeListener(e.get(r))}}),m=new s((e=>"function"!=typeof e?e:function(t){const r=g(t,{},{getContent:{minArgs:0,maxArgs:0}});e(r)})),u=new s((e=>"function"!=typeof e?e:function(t,r,s){let o,a,i=!1,c=new Promise((e=>{o=function(t){i=!0,e(t)}}));try{a=e(t,r,o)}catch(e){a=Promise.reject(e)}const d=!0!==a&&n(a);if(!0!==a&&!d&&!i)return!1;const g=e=>{e.then((e=>{s(e)}),(e=>{let t;t=e&&(e instanceof Error||"string"==typeof e.message)?e.message:"An unexpected error occurred",s({__mozWebExtensionPolyfillReject__:!0,message:t})})).catch((e=>{console.error("Failed to send onMessage rejected reply",e)}))};return g(d?a:c),!0})),h=({reject:r,resolve:s},n)=>{e.runtime.lastError?e.runtime.lastError.message===t?s():r(new Error(e.runtime.lastError.message)):n&&n.__mozWebExtensionPolyfillReject__?r(new Error(n.message)):s(n)},p=(e,t,r,...s)=>{if(s.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${a(t.minArgs)} for ${e}(), got ${s.length}`);if(s.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${a(t.maxArgs)} for ${e}(), got ${s.length}`);return new Promise(((e,t)=>{const n=h.bind(null,{resolve:e,reject:t});s.push(n),r.sendMessage(...s)}))},f={devtools:{network:{onRequestFinished:l(m)}},runtime:{onMessage:l(u),onMessageExternal:l(u),sendMessage:p.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:p.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},A={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return r.privacy={network:{"*":A},services:{"*":A},websites:{"*":A}},g(e,f,r)};e.exports=r(chrome)}else e.exports=globalThis.browser}(e)}(n);var o=s(n.exports);let a;const i=new Uint8Array(16);function c(){if(!a&&(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!a))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(i)}const d=[];for(let e=0;e<256;++e)d.push((e+256).toString(16).slice(1));var g={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function l(e,t,r){if(g.randomUUID&&!e)return g.randomUUID();const s=(e=e||{}).random||(e.rng||c)();return s[6]=15&s[6]|64,s[8]=63&s[8]|128,function(e,t=0){return d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+"-"+d[e[t+4]]+d[e[t+5]]+"-"+d[e[t+6]]+d[e[t+7]]+"-"+d[e[t+8]]+d[e[t+9]]+"-"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]}(s)}class m{async sendMessage(t,s={}){try{let e="";return await this.doSendMessage({prompt:t,image:s.image,signal:s.signal,onEvent:t=>{"UPDATE_ANSWER"===t.type&&(e=t.data.text,s.onProgress?.(e))}}),e}catch(t){if(t instanceof r)throw t;throw new r(t instanceof Error?t.message:String(t),e.ErrorCode.UNKNOWN_ERROR)}}async loadThreadsFromStorage(){try{return(await o.storage.local.get(m.THREADS_STORAGE_KEY))[m.THREADS_STORAGE_KEY]||[]}catch(e){return console.error("Failed to load threads from storage:",e),[]}}async saveThreadsToStorage(e){try{await o.storage.local.set({[m.THREADS_STORAGE_KEY]:e})}catch(e){console.error("Failed to save threads to storage:",e)}}getCurrentThread(){return this.currentThread}async loadThread(e){const t=(await this.loadThreadsFromStorage()).find((t=>t.id===e));if(!t)throw new Error("Thread not found");this.currentThread=t}async saveThread(e){if(!this.currentThread)throw new Error("No active thread to save");const t=await this.loadThreadsFromStorage(),r=t.findIndex((e=>e.id===this.currentThread.id));-1!==r?t[r]=this.currentThread:t.push(this.currentThread),await this.saveThreadsToStorage(t)}async getAllThreads(){return this.loadThreadsFromStorage()}async deleteThread(e){const t=await this.loadThreadsFromStorage();await this.saveThreadsToStorage(t.filter((t=>t.id!==e))),this.currentThread?.id===e&&this.initNewThread()}createMessage(e,t){return{id:l(),role:e,content:t,timestamp:Date.now()}}}async function*u(e){const t=e.getReader();try{for(;;){const{done:e,value:r}=await t.read();if(e)return;yield r}}finally{t.releaseLock()}}async function h(e,t){const r=e.body.getReader(),s=new TextDecoder;let n="";for(;;){const{done:e,value:o}=await r.read();if(e)break;n+=s.decode(o,{stream:!0});const a=n.split("\n");n=a.pop()||"";for(const e of a){const r=e.trim();if(r&&r.startsWith("data: ")){t(r.slice(6))}}}if(n.trim()&&n.startsWith("data: ")){t(n.slice(6))}}function p(e,t=!1){return new Promise(((r,s)=>{const n=new FileReader;n.readAsDataURL(e),n.onload=()=>{const e=n.result;r(t?e:e.split(",")[1])},n.onerror=s}))}m.THREADS_STORAGE_KEY="chat_threads";const f=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,A=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,E=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/;function y(e,t){if(!("__proto__"===e||"constructor"===e&&t&&"object"==typeof t&&"prototype"in t))return t;!function(e){console.warn(`[destr] Dropping "${e}" key to prevent prototype pollution.`)}(e)}function w(e,t={}){if("string"!=typeof e)return e;const r=e.trim();if('"'===e[0]&&e.endsWith('"')&&!e.includes("\\"))return r.slice(1,-1);if(r.length<=9){const e=r.toLowerCase();if("true"===e)return!0;if("false"===e)return!1;if("undefined"===e)return;if("null"===e)return null;if("nan"===e)return Number.NaN;if("infinity"===e)return Number.POSITIVE_INFINITY;if("-infinity"===e)return Number.NEGATIVE_INFINITY}if(!E.test(e)){if(t.strict)throw new SyntaxError("[destr] Invalid JSON");return e}try{if(f.test(e)||A.test(e)){if(t.strict)throw new Error("[destr] Possible prototype pollution");return JSON.parse(e,y)}return JSON.parse(e)}catch(r){if(t.strict)throw r;return e}}const T=/#/g,x=/&/g,S=/\//g,C=/=/g,b=/\+/g,_=/%5e/gi,v=/%60/gi,N=/%7c/gi,R=/%20/gi;function I(e){return(t="string"==typeof e?e:JSON.stringify(e),encodeURI(""+t).replace(N,"|")).replace(b,"%2B").replace(R,"+").replace(T,"%23").replace(x,"%26").replace(v,"`").replace(_,"^").replace(S,"%2F");var t}function O(e){return I(e).replace(C,"%3D")}function M(e=""){try{return decodeURIComponent(""+e)}catch{return""+e}}function P(e){return M(e.replace(b," "))}function k(e=""){const t={};"?"===e[0]&&(e=e.slice(1));for(const r of e.split("&")){const e=r.match(/([^=]+)=?(.*)/)||[];if(e.length<2)continue;const s=M(e[1].replace(b," "));if("__proto__"===s||"constructor"===s)continue;const n=P(e[2]||"");void 0===t[s]?t[s]=n:Array.isArray(t[s])?t[s].push(n):t[s]=[t[s],n]}return t}function U(e){return Object.keys(e).filter((t=>void 0!==e[t])).map((t=>{return r=t,"number"!=typeof(s=e[t])&&"boolean"!=typeof s||(s=String(s)),s?Array.isArray(s)?s.map((e=>`${O(r)}=${I(e)}`)).join("&"):`${O(r)}=${I(s)}`:O(r);var r,s})).filter(Boolean).join("&")}const D=/^[\s\w\0+.-]{2,}:([/\\]{1,2})/,L=/^[\s\w\0+.-]{2,}:([/\\]{2})?/,F=/^([/\\]\s*){2,}[^/\\]/,K=/^\.?\//;function B(e,t={}){return"boolean"==typeof t&&(t={acceptRelative:t}),t.strict?D.test(e):L.test(e)||!!t.acceptRelative&&F.test(e)}function j(e="",t){return e.endsWith("/")?e:e+"/"}function $(e,t){if(!(r=t)||"/"===r||B(e))return e;var r;const s=function(e=""){return(function(e=""){return e.endsWith("/")}(e)?e.slice(0,-1):e)||"/"}(t);return e.startsWith(s)?e:function(e,...t){let r=e||"";for(const e of t.filter((e=>function(e){return e&&"/"!==e}(e))))if(r){const t=e.replace(K,"");r=j(r)+t}else r=e;return r}(s,e)}function H(e,t){const r=function(e=""){const t=e.match(/^[\s\0]*(blob:|data:|javascript:|vbscript:)(.*)/i);if(t){const[,e,r=""]=t;return{protocol:e.toLowerCase(),pathname:r,href:e+r,auth:"",host:"",search:"",hash:""}}if(!B(e,{acceptRelative:!0}))return q(e);const[,r="",s,n=""]=e.replace(/\\/g,"/").match(/^[\s\0]*([\w+.-]{2,}:)?\/\/([^/@]+@)?(.*)/)||[];let[,o="",a=""]=n.match(/([^#/?]*)(.*)?/)||[];"file:"===r&&(a=a.replace(/\/(?=[A-Za-z]:)/,""));const{pathname:i,search:c,hash:d}=q(a);return{protocol:r.toLowerCase(),auth:s?s.slice(0,Math.max(0,s.length-1)):"",host:o,pathname:i,search:c,hash:d,[G]:!r}}(e),s={...k(r.search),...t};return r.search=U(s),function(e){const t=e.pathname||"",r=e.search?(e.search.startsWith("?")?"":"?")+e.search:"",s=e.hash||"",n=e.auth?e.auth+"@":"",o=e.host||"",a=e.protocol||e[G]?(e.protocol||"")+"//":"";return a+n+o+t+r+s}(r)}const G=Symbol.for("ufo:protocolRelative");function q(e=""){const[t="",r="",s=""]=(e.match(/([^#?]*)(\?[^#]*)?(#.*)?/)||[]).splice(1);return{pathname:t,search:r,hash:s}}class W extends Error{constructor(e,t){super(e,t),this.name="FetchError",t?.cause&&!this.cause&&(this.cause=t.cause)}}const V=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function Y(e="GET"){return V.has(e.toUpperCase())}const z=new Set(["image/svg","application/xml","application/xhtml","application/html"]),J=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function Z(e,t,r,s){const n=function(e,t,r){if(!t)return new r(e);const s=new r(t);if(e)for(const[t,n]of Symbol.iterator in e||Array.isArray(e)?e:new r(e))s.set(t,n);return s}(t?.headers??e?.headers,r?.headers,s);let o;return(r?.query||r?.params||t?.params||t?.query)&&(o={...r?.params,...r?.query,...t?.params,...t?.query}),{...r,...t,query:o,params:o,headers:n}}async function X(e,t){if(t)if(Array.isArray(t))for(const r of t)await r(e);else await t(e)}const Q=new Set([408,409,425,429,500,502,503,504]),ee=new Set([101,204,205,304]);const te=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),re=function e(t={}){const{fetch:r=globalThis.fetch,Headers:s=globalThis.Headers,AbortController:n=globalThis.AbortController}=t;async function o(e){const t=e.error&&"AbortError"===e.error.name&&!e.options.timeout||!1;if(!1!==e.options.retry&&!t){let t;t="number"==typeof e.options.retry?e.options.retry:Y(e.options.method)?0:1;const r=e.response&&e.response.status||500;if(t>0&&(Array.isArray(e.options.retryStatusCodes)?e.options.retryStatusCodes.includes(r):Q.has(r))){const r="function"==typeof e.options.retryDelay?e.options.retryDelay(e):e.options.retryDelay||0;return r>0&&await new Promise((e=>setTimeout(e,r))),a(e.request,{...e.options,retry:t-1})}}const r=function(e){const t=e.error?.message||e.error?.toString()||"",r=e.request?.method||e.options?.method||"GET",s=e.request?.url||String(e.request)||"/",n=`[${r}] ${JSON.stringify(s)}`,o=e.response?`${e.response.status} ${e.response.statusText}`:"<no response>",a=new W(`${n}: ${o}${t?` ${t}`:""}`,e.error?{cause:e.error}:void 0);for(const t of["request","options","response"])Object.defineProperty(a,t,{get:()=>e[t]});for(const[t,r]of[["data","_data"],["status","status"],["statusCode","status"],["statusText","statusText"],["statusMessage","statusText"]])Object.defineProperty(a,t,{get:()=>e.response&&e.response[r]});return a}(e);throw Error.captureStackTrace&&Error.captureStackTrace(r,a),r}const a=async function(e,a={}){const i={request:e,options:Z(e,a,t.defaults,s),response:void 0,error:void 0};let c;if(i.options.method&&(i.options.method=i.options.method.toUpperCase()),i.options.onRequest&&await X(i,i.options.onRequest),"string"==typeof i.request&&(i.options.baseURL&&(i.request=$(i.request,i.options.baseURL)),i.options.query&&(i.request=H(i.request,i.options.query),delete i.options.query),"query"in i.options&&delete i.options.query,"params"in i.options&&delete i.options.params),i.options.body&&Y(i.options.method)&&(!function(e){if(void 0===e)return!1;const t=typeof e;return"string"===t||"number"===t||"boolean"===t||null===t||"object"===t&&(!!Array.isArray(e)||!e.buffer&&(e.constructor&&"Object"===e.constructor.name||"function"==typeof e.toJSON))}(i.options.body)?("pipeTo"in i.options.body&&"function"==typeof i.options.body.pipeTo||"function"==typeof i.options.body.pipe)&&("duplex"in i.options||(i.options.duplex="half")):(i.options.body="string"==typeof i.options.body?i.options.body:JSON.stringify(i.options.body),i.options.headers=new s(i.options.headers||{}),i.options.headers.has("content-type")||i.options.headers.set("content-type","application/json"),i.options.headers.has("accept")||i.options.headers.set("accept","application/json"))),!i.options.signal&&i.options.timeout){const e=new n;c=setTimeout((()=>{const t=new Error("[TimeoutError]: The operation was aborted due to timeout");t.name="TimeoutError",t.code=23,e.abort(t)}),i.options.timeout),i.options.signal=e.signal}try{i.response=await r(i.request,i.options)}catch(e){return i.error=e,i.options.onRequestError&&await X(i,i.options.onRequestError),await o(i)}finally{c&&clearTimeout(c)}if((i.response.body||i.response._bodyInit)&&!ee.has(i.response.status)&&"HEAD"!==i.options.method){const e=(i.options.parseResponse?"json":i.options.responseType)||function(e=""){if(!e)return"json";const t=e.split(";").shift()||"";return J.test(t)?"json":z.has(t)||t.startsWith("text/")?"text":"blob"}(i.response.headers.get("content-type")||"");switch(e){case"json":{const e=await i.response.text(),t=i.options.parseResponse||w;i.response._data=t(e);break}case"stream":i.response._data=i.response.body||i.response._bodyInit;break;default:i.response._data=await i.response[e]()}}return i.options.onResponse&&await X(i,i.options.onResponse),!i.options.ignoreResponseError&&i.response.status>=400&&i.response.status<600?(i.options.onResponseError&&await X(i,i.options.onResponseError),await o(i)):i.response},i=async function(e,t){return(await a(e,t))._data};return i.raw=a,i.native=(...e)=>r(...e),i.create=(r={},s={})=>e({...t,...s,defaults:{...t.defaults,...s.defaults,...r}}),i}({fetch:te.fetch?(...e)=>te.fetch(...e):()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!")),Headers:te.Headers,AbortController:te.AbortController});function se(e,t){const r=new RegExp(`"${e}":"([^"]+)"`).exec(t);return r?.[1]}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
var ne,oe,ae,ie,ce,de;!function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"}(ne||(ne={})),function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"}(oe||(oe={})),function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"}(ae||(ae={})),function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"}(ie||(ie={})),function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.OTHER="OTHER"}(ce||(ce={})),function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"}(de||(de={}));
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
class ge extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class le extends ge{constructor(e,t){super(e),this.response=t}}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */var me;!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(me||(me={}));class ue{constructor(e,t,r,s){this.model=e,this.task=t,this.apiKey=r,this.stream=s}toString(){let e=`https://generativelanguage.googleapis.com/v1/models/${this.model}:${this.task}`;return this.stream&&(e+="?alt=sse"),e}}async function he(e,t){let r;try{if(r=await fetch(e.toString(),{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-client":"genai-js/0.1.3","x-goog-api-key":e.apiKey},body:t}),!r.ok){let e="";try{const t=await r.json();e=t.error.message,t.error.details&&(e+=` ${JSON.stringify(t.error.details)}`)}catch(e){}throw new Error(`[${r.status} ${r.statusText}] ${e}`)}}catch(t){const r=new ge(`Error fetching from ${e.toString()}: ${t.message}`);throw r.stack=t.stack,r}return r}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */function pe(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Ae(e.candidates[0]))throw new le(`${Ee(e)}`,e);return function(e){var t,r,s,n;return(null===(n=null===(s=null===(r=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===r?void 0:r.parts)||void 0===s?void 0:s[0])||void 0===n?void 0:n.text)?e.candidates[0].content.parts[0].text:""}(e)}if(e.promptFeedback)throw new le(`Text not available. ${Ee(e)}`,e);return""},e}const fe=[ce.RECITATION,ce.SAFETY];function Ae(e){return!!e.finishReason&&fe.includes(e.finishReason)}function Ee(e){var t,r,s;let n="";if(e.candidates&&0!==e.candidates.length||!e.promptFeedback){if(null===(s=e.candidates)||void 0===s?void 0:s[0]){const t=e.candidates[0];Ae(t)&&(n+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(n+=`: ${t.finishMessage}`))}}else n+="Response was blocked",(null===(t=e.promptFeedback)||void 0===t?void 0:t.blockReason)&&(n+=` due to ${e.promptFeedback.blockReason}`),(null===(r=e.promptFeedback)||void 0===r?void 0:r.blockReasonMessage)&&(n+=`: ${e.promptFeedback.blockReasonMessage}`);return n}function ye(e){return this instanceof ye?(this.v=e,this):new ye(e)}function we(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s,n=r.apply(e,t||[]),o=[];return s={},a("next"),a("throw"),a("return"),s[Symbol.asyncIterator]=function(){return this},s;function a(e){n[e]&&(s[e]=function(t){return new Promise((function(r,s){o.push([e,t,r,s])>1||i(e,t)}))})}function i(e,t){try{(r=n[e](t)).value instanceof ye?Promise.resolve(r.value.v).then(c,d):g(o[0][2],r)}catch(e){g(o[0][3],e)}var r}function c(e){i("next",e)}function d(e){i("throw",e)}function g(e,t){e(t),o.shift(),o.length&&i(o[0][0],o[0][1])}}"function"==typeof SuppressedError&&SuppressedError;
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
const Te=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function xe(e){const t=function(e){const t=e.getReader();return new ReadableStream({start(e){let r="";return s();function s(){return t.read().then((({value:t,done:n})=>{if(n)return r.trim()?void e.error(new ge("Failed to parse stream")):void e.close();r+=t;let o,a=r.match(Te);for(;a;){try{o=JSON.parse(a[1])}catch(t){return void e.error(new ge(`Error parsing JSON response: "${a[1]}"`))}e.enqueue(o),r=r.substring(a[0].length),a=r.match(Te)}return s()}))}}})}(e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))),[r,s]=t.tee();return{stream:Ce(r),response:Se(s)}}async function Se(e){const t=[],r=e.getReader();for(;;){const{done:e,value:s}=await r.read();if(e)return pe(be(t));t.push(s)}}function Ce(e){return we(this,arguments,(function*(){const t=e.getReader();for(;;){const{value:e,done:r}=yield ye(t.read());if(r)break;yield yield ye(pe(e))}}))}function be(e){const t=e[e.length-1],r={promptFeedback:null==t?void 0:t.promptFeedback};for(const t of e)if(t.candidates)for(const e of t.candidates){const t=e.index;if(r.candidates||(r.candidates=[]),r.candidates[t]||(r.candidates[t]={index:e.index}),r.candidates[t].citationMetadata=e.citationMetadata,r.candidates[t].finishReason=e.finishReason,r.candidates[t].finishMessage=e.finishMessage,r.candidates[t].safetyRatings=e.safetyRatings,e.content&&e.content.parts){r.candidates[t].content||(r.candidates[t].content={role:e.content.role||"user",parts:[{text:""}]});for(const s of e.content.parts)s.text&&(r.candidates[t].content.parts[0].text+=s.text)}}return r}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */async function _e(e,t,r){const s=new ue(t,me.STREAM_GENERATE_CONTENT,e,!0);return xe(await he(s,JSON.stringify(r)))}async function ve(e,t,r){const s=new ue(t,me.GENERATE_CONTENT,e,!1),n=await he(s,JSON.stringify(r));return{response:pe(await n.json())}}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */function Ne(e,t){let r=[];if("string"==typeof e)r=[{text:e}];else for(const t of e)"string"==typeof t?r.push({text:t}):r.push(t);return{role:t,parts:r}}function Re(e){if(e.contents)return e;return{contents:[Ne(e,"user")]}}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
const Ie="SILENT_ERROR";class Oe{constructor(e,t,r){this.model=t,this.params=r,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==r?void 0:r.history)&&(this._history=r.history.map((e=>{if(!e.role)throw new Error("Missing role for history item: "+JSON.stringify(e));return Ne(e.parts,e.role)})))}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e){var t,r;await this._sendPromise;const s=Ne(e,"user"),n={safetySettings:null===(t=this.params)||void 0===t?void 0:t.safetySettings,generationConfig:null===(r=this.params)||void 0===r?void 0:r.generationConfig,contents:[...this._history,s]};let o;return this._sendPromise=this._sendPromise.then((()=>ve(this._apiKey,this.model,n))).then((e=>{var t;if(e.response.candidates&&e.response.candidates.length>0){this._history.push(s);const r=Object.assign({parts:[],role:"model"},null===(t=e.response.candidates)||void 0===t?void 0:t[0].content);this._history.push(r)}else{const t=Ee(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}o=e})),await this._sendPromise,o}async sendMessageStream(e){var t,r;await this._sendPromise;const s=Ne(e,"user"),n={safetySettings:null===(t=this.params)||void 0===t?void 0:t.safetySettings,generationConfig:null===(r=this.params)||void 0===r?void 0:r.generationConfig,contents:[...this._history,s]},o=_e(this._apiKey,this.model,n);return this._sendPromise=this._sendPromise.then((()=>o)).catch((e=>{throw new Error(Ie)})).then((e=>e.response)).then((e=>{if(e.candidates&&e.candidates.length>0){this._history.push(s);const t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{const t=Ee(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}})).catch((e=>{e.message!==Ie&&console.error(e)})),o}}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */
class Me{constructor(e,t){var r;this.apiKey=e,t.model.startsWith("models/")?this.model=null===(r=t.model.split("models/"))||void 0===r?void 0:r[1]:this.model=t.model,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[]}async generateContent(e){const t=Re(e);return ve(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings},t))}async generateContentStream(e){const t=Re(e);return _e(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings},t))}startChat(e){return new Oe(this.apiKey,this.model,e)}async countTokens(e){const t=Re(e);return async function(e,t,r){const s=new ue(t,me.COUNT_TOKENS,e,!1);return(await he(s,JSON.stringify(Object.assign(Object.assign({},r),{model:t})))).json()}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */(this.apiKey,this.model,t)}async embedContent(e){const t=function(e){if("string"==typeof e||Array.isArray(e))return{content:Ne(e,"user")};return e}(e);return async function(e,t,r){const s=new ue(t,me.EMBED_CONTENT,e,!1);return(await he(s,JSON.stringify(r))).json()}(this.apiKey,this.model,t)}async batchEmbedContents(e){return async function(e,t,r){const s=new ue(t,me.BATCH_EMBED_CONTENTS,e,!1),n=r.requests.map((e=>Object.assign(Object.assign({},e),{model:`models/${t}`})));return(await he(s,JSON.stringify({requests:n}))).json()}(this.apiKey,this.model,e)}}
/**
     * @license
     * Copyright 2023 Google LLC
     *
     * Licensed under the Apache License, Version 2.0 (the "License");
     * you may not use this file except in compliance with the License.
     * You may obtain a copy of the License at
     *
     *   http://www.apache.org/licenses/LICENSE-2.0
     *
     * Unless required by applicable law or agreed to in writing, software
     * distributed under the License is distributed on an "AS IS" BASIS,
     * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
     * See the License for the specific language governing permissions and
     * limitations under the License.
     */var Pe=Object.freeze({__proto__:null,get BlockReason(){return ie},ChatSession:Oe,get FinishReason(){return ce},GenerativeModel:Me,GoogleGenerativeAI:class{constructor(e){this.apiKey=e}getGenerativeModel(e){if(!e.model)throw new ge("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Me(this.apiKey,e)}},get HarmBlockThreshold(){return oe},get HarmCategory(){return ne},get HarmProbability(){return ae},get TaskType(){return de}});e.AIModelError=r,e.AbstractModel=m,e.BaichuanWebModel=class extends m{getName(){return"百川大模型"}supportsImageInput(){return!1}resetConversation(){this.conversationContext=void 0}generateSessionId(){return l().replace(/-/g,"")}generateMessageId(){return l().replace(/-/g,"")}async getUserInfo(){try{const t=await fetch("https://www.baichuan-ai.com/api/user/info",{headers:{"Content-Type":"application/json"}});if(!t.ok)throw new r("Failed to get user info",e.ErrorCode.UNAUTHORIZED);return{id:(await t.json()).data.id||Math.floor(1e6*Math.random())}}catch(e){return{id:Math.floor(1e6*Math.random())}}}async doSendMessage(t){try{if(!this.conversationContext){const e=this.generateSessionId(),t=await this.getUserInfo();this.conversationContext={conversationId:e,historyMessages:[],userId:t.id}}const{conversationId:s,lastMessageId:n,historyMessages:o,userId:a}=this.conversationContext,i={id:this.generateMessageId(),createdAt:Date.now(),data:t.prompt,from:0},c=await fetch("https://www.baichuan-ai.com/api/chat/v1/chat",{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json"},body:JSON.stringify({assistant:{},assistant_info:{},retry:3,type:"input",stream:!0,request_id:l(),app_info:{id:10001,name:"baichuan_web"},user_info:{id:a,status:1},prompt:{id:i.id,data:i.data,from:i.from,parent_id:n||0,created_at:i.createdAt,attachments:[]},session_info:{id:s,name:"新的对话",created_at:Date.now()},parameters:{repetition_penalty:-1,temperature:-1,top_k:-1,top_p:-1,max_new_tokens:-1,do_sample:-1,regenerate:0,wse:!0},history:o})});if(!c.ok)throw new r(`HTTP error ${c.status}`,e.ErrorCode.SERVICE_UNAVAILABLE);const d=new TextDecoder;let g,m="";for await(const e of u(c.body)){const r=d.decode(e).split("\n");for(const e of r)if(e)try{const r=JSON.parse(e);if(!r.answer)continue;g=r.answer.id;const s=r.answer.data;s&&(m+=s,t.onEvent({type:"UPDATE_ANSWER",data:{text:m}}))}catch(e){console.error("Error parsing Baichuan stream:",e)}}this.conversationContext.historyMessages.push(i),g&&(this.conversationContext.lastMessageId=g,m&&this.conversationContext.historyMessages.push({id:g,data:m,createdAt:Date.now(),from:1})),t.onEvent({type:"DONE"})}catch(t){if(t instanceof r)throw t;if(t instanceof DOMException&&"AbortError"===t.name)return;throw new r(t instanceof Error?t.message:String(t),e.ErrorCode.NETWORK_ERROR)}}async initNewThread(){this.conversationContext=void 0}},e.BardModel=class extends m{constructor(){super(),this.initializeStorage().catch(console.error)}async initializeStorage(){(await this.loadThreadsFromStorage()).length||await this.saveThreadsToStorage([]),await this.validateExistingThreads()}async validateExistingThreads(){const e=await this.loadThreadsFromStorage();let t=!1;for(const r of e)r.modelName!==this.getName()||this.isValidBardMetadata(r.metadata)||(await this.deleteThread(r.id),t=!0);t&&await this.saveThreadsToStorage(e.filter((e=>e.modelName!==this.getName()||this.isValidBardMetadata(e.metadata))))}isValidBardMetadata(e){return e?.contextIds&&e?.requestParams}getName(){return"Google Bard"}supportsImageInput(){return!0}async fetchRequestParams(){try{const t=await re("https://gemini.google.com/",{responseType:"text"}),s=se("SNlM0e",t),n=se("cfb2h",t);if(!s||!n)throw new r("Failed to extract Bard parameters",e.ErrorCode.UNAUTHORIZED);return{atValue:s,blValue:n}}catch(t){throw new r("Failed to initialize Bard session",e.ErrorCode.UNAUTHORIZED)}}parseBardResponse(t){try{const e=t.split("\n").find((e=>e.startsWith("[")));if(!e)throw new Error("Invalid response format");const r=JSON.parse(e),s=JSON.parse(r[0][2]);if(!s)throw new Error("Empty response data");const n=s[4][0][1][0],o=[s[1][0],s[1][1],s[4][0][0]],a=s[4][0][4]||[];let i=n;for(const e of a){const[t,r,s]=e;i=i.replace(s,`[![${t[4]}](${t[0][0]})](${r[0][0]})`)}return{text:i,ids:o}}catch(t){throw console.error("Error parsing Bard response:",t),new r("Failed to parse Bard response",e.ErrorCode.UNKNOWN_ERROR)}}async uploadImage(t){const s={"content-type":"application/x-www-form-urlencoded;charset=UTF-8","push-id":"feeds/mcudyrk2a4khkz","x-goog-upload-header-content-length":t.size.toString(),"x-goog-upload-protocol":"resumable","x-tenant-id":"bard-storage"},n=(await re.raw("https://content-push.googleapis.com/upload/",{method:"POST",headers:{...s,"x-goog-upload-command":"start"},body:new URLSearchParams({[`File name: ${t.name}`]:""})})).headers.get("x-goog-upload-url");if(!n)throw new r("Failed to upload image",e.ErrorCode.UNKNOWN_ERROR);return await re(n,{method:"POST",headers:{...s,"x-goog-upload-command":"upload, finalize","x-goog-upload-offset":"0"},body:t})}async ensureThreadLoaded(){if(!this.currentThread){const e=(await this.loadThreadsFromStorage()).filter((e=>e.modelName===this.getName()&&this.isValidBardMetadata(e.metadata)));if(e.length>0){const t=e.sort(((e,t)=>t.updatedAt-e.updatedAt))[0];this.currentThread=t,console.log("Loaded existing thread from storage:",this.currentThread.id)}else await this.initNewThread()}}async doSendMessage(t){try{t.onEvent({type:"UPDATE_ANSWER",data:{text:""}}),await this.ensureThreadLoaded();const e=this.getCurrentThreadSafe(),r=this.createMessage("user",t.prompt);e.messages.push(r);const s=this.getBardMetadata();let n;console.log("Current context IDs before request:",s.contextIds),t.image&&(n=await this.uploadImage(t.image));const o=[null,JSON.stringify([[t.prompt,0,null,n?[[[n,1],t.image.name]]:[]],null,s.contextIds])],a=await re("https://gemini.google.com/_/BardChatUi/data/assistant.lamda.BardFrontendService/StreamGenerate",{method:"POST",signal:t.signal,query:{bl:s.requestParams.blValue,_reqid:Math.floor(9e5*Math.random())+1e5,rt:"c"},body:new URLSearchParams({at:s.requestParams.atValue,"f.req":JSON.stringify(o)}),parseResponse:e=>e}),{text:i,ids:c}=this.parseBardResponse(a);console.log("New context IDs after response:",c);const d=this.createMessage("assistant",i);d.metadata={messageId:c[0]},e.messages.push(d),e.metadata&&(e.metadata.contextIds=c),e.updatedAt=Date.now(),await this.saveThread(),t.onEvent({type:"UPDATE_ANSWER",data:{text:i,messageId:c[0],conversationId:c[1],messages:e.messages}}),t.onEvent({type:"DONE"})}catch(s){throw t.onEvent({type:"ERROR",data:{error:s instanceof r?s:new r(s instanceof Error?s.message:String(s),e.ErrorCode.NETWORK_ERROR)}}),s}}async loadThread(e){const t=await this.loadThreadsFromStorage(),r=t.find((t=>t.id===e));if(r&&r.modelName===this.getName()){this.currentThread=r;this.currentThread.metadata.requestParams=await this.fetchRequestParams(),await this.saveThread(),await this.saveThreadsToStorage(t)}}getBardMetadata(){const t=this.getCurrentThreadSafe();if(!t.metadata)throw new r("No thread metadata available",e.ErrorCode.INVALID_REQUEST);const s=t.metadata;if(!s.contextIds||!s.requestParams)throw new r("Invalid thread metadata",e.ErrorCode.INVALID_REQUEST);return s}getCurrentThreadSafe(){if(!this.currentThread)throw new r("No active thread",e.ErrorCode.INVALID_REQUEST);return this.currentThread}async initNewThread(){this.currentThread={id:l(),title:"New Conversation",messages:[],createdAt:Date.now(),updatedAt:Date.now(),modelName:this.getName(),metadata:{contextIds:["","",""],requestParams:await this.fetchRequestParams()}},await this.saveThread()}async saveThread(){if(!this.currentThread)return;const e=await this.loadThreadsFromStorage(),t=e.findIndex((e=>e.id===this.currentThread.id));-1!==t?e[t]=this.currentThread:e.push(this.currentThread),await this.saveThreadsToStorage(e)}},e.ChatGPTApiModel=class extends m{constructor(e){super(),this.apiKey=e.apiKey,this.model=e.model||"gpt-3.5-turbo",this.systemMessage=e.systemMessage||"You are ChatGPT, a large language model trained by OpenAI. Answer as concisely as possible. Current date: {current_date}"}getName(){return`ChatGPT API (${this.model})`}supportsImageInput(){return this.model.includes("gpt-4")&&this.model.includes("vision")}resetConversation(){this.conversationContext=void 0}buildUserMessage(e,t){return t?{role:"user",content:[{type:"text",text:e},{type:"image_url",image_url:{url:t,detail:"low"}}]}:{role:"user",content:e}}buildMessages(e,t){const r=(new Date).toISOString().split("T")[0];return[{role:"system",content:this.systemMessage.replace("{current_date}",r)},...this.conversationContext.messages.slice(-10),this.buildUserMessage(e,t)]}async doSendMessage(t){if(!this.apiKey)throw new r("ChatGPT API key is required",e.ErrorCode.MISSING_API_KEY);let s;if(this.conversationContext||(this.conversationContext={messages:[]}),t.image){if(!this.supportsImageInput())throw new r(`The model ${this.model} does not support image input`,e.ErrorCode.UNKNOWN_ERROR);s=await p(t.image,!0)}const n=this.buildMessages(t.prompt,s);try{const o=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:this.model,messages:n,stream:!0}),signal:t.signal});if(!o.ok){const t=await o.json().catch((()=>({})));throw new r(t.error?.message||`HTTP error ${o.status}`,401===o.status?e.ErrorCode.UNAUTHORIZED:e.ErrorCode.SERVICE_UNAVAILABLE)}this.conversationContext.messages.push(this.buildUserMessage(t.prompt,s));let a=!1;const i={role:"assistant",content:""},c=()=>{a=!0,t.onEvent({type:"DONE"});this.conversationContext.messages.push(i)};await h(o,(e=>{if("[DONE]"===e)return void c();let r;try{r=JSON.parse(e)}catch(e){return void console.error(e)}if(r?.choices?.length){const e=r.choices[0].delta;e?.content&&"string"==typeof i.content&&(i.content+=e.content,t.onEvent({type:"UPDATE_ANSWER",data:{text:i.content}}))}})),a||c()}catch(t){if(t instanceof r)throw t;if(t instanceof DOMException&&"AbortError"===t.name)return;throw new r(t instanceof Error?t.message:String(t),e.ErrorCode.NETWORK_ERROR)}}async initNewThread(){this.resetConversation()}},e.ClaudeWebModel=class extends m{constructor(e){super(),this.sessionKey=e.sessionKey,this.model="claude-2.1"}getName(){return"Claude (webapp/claude-2)"}supportsImageInput(){return!1}resetConversation(){this.conversationContext=void 0}async fetchOrganizationId(){try{const t=await fetch("https://claude.ai/api/organizations",{headers:{Cookie:`sessionKey=${this.sessionKey}`}});if(!t.ok)throw new r("Failed to fetch organization ID",e.ErrorCode.UNAUTHORIZED);const s=await t.json();if(!s||!s.length)throw new r("No organizations found",e.ErrorCode.UNAUTHORIZED);return s[0].uuid}catch(t){if(t instanceof r)throw t;throw new r("Failed to fetch organization ID",e.ErrorCode.NETWORK_ERROR)}}async createConversation(t){try{const s=await fetch("https://claude.ai/api/organizations/"+t+"/chat_conversations",{method:"POST",headers:{"Content-Type":"application/json",Cookie:`sessionKey=${this.sessionKey}`},body:JSON.stringify({name:"",uuid:crypto.randomUUID()})});if(!s.ok)throw new r("Failed to create conversation",e.ErrorCode.SERVICE_UNAVAILABLE);return(await s.json()).uuid}catch(t){if(t instanceof r)throw t;throw new r("Failed to create conversation",e.ErrorCode.NETWORK_ERROR)}}async generateChatTitle(e,t,r){try{await fetch("https://claude.ai/api/generate_chat_title",{method:"POST",headers:{"Content-Type":"application/json",Cookie:`sessionKey=${this.sessionKey}`},body:JSON.stringify({organization_uuid:e,conversation_uuid:t,message_content:r,recent_titles:[]})})}catch(e){console.error("Failed to generate chat title:",e)}}async doSendMessage(t){try{if(this.organizationId||(this.organizationId=await this.fetchOrganizationId()),!this.conversationContext){const e=await this.createConversation(this.organizationId);this.conversationContext={conversationId:e},this.generateChatTitle(this.organizationId,e,t.prompt).catch(console.error)}const s=await fetch("https://claude.ai/api/append_message",{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Cookie:`sessionKey=${this.sessionKey}`},body:JSON.stringify({organization_uuid:this.organizationId,conversation_uuid:this.conversationContext.conversationId,text:t.prompt,completion:{prompt:t.prompt,model:this.model},attachments:[]})});if(!s.ok&&403===s.status&&"claude-2.1"===this.model){if((await s.text()).includes("model_not_allowed"))return this.model="claude-2.0",this.doSendMessage(t)}if(!s.ok)throw new r(`HTTP error ${s.status}`,e.ErrorCode.SERVICE_UNAVAILABLE);let n="";await h(s,(s=>{try{const o=JSON.parse(s);if(o.completion)n+=o.completion,t.onEvent({type:"UPDATE_ANSWER",data:{text:n.trimStart()}});else if(o.error)throw new r(JSON.stringify(o.error),e.ErrorCode.SERVICE_UNAVAILABLE)}catch(e){if(e instanceof r)throw e;console.error("Error parsing Claude SSE message:",e)}})),t.onEvent({type:"DONE"})}catch(t){if(t instanceof r)throw t;if(t instanceof DOMException&&"AbortError"===t.name)return;throw new r(t instanceof Error?t.message:String(t),e.ErrorCode.NETWORK_ERROR)}}async initNewThread(){this.resetConversation()}},e.GeminiApiModel=class extends m{constructor(e){super(),this.sdk=null,this.initializeSDK(e.apiKey)}async initializeSDK(e){try{const{GoogleGenerativeAI:t}=await Promise.resolve().then((function(){return Pe}));this.sdk=new t(e)}catch(e){console.error("Failed to initialize Gemini SDK:",e)}}getName(){return"Gemini Pro"}supportsImageInput(){return!1}resetConversation(){this.conversationContext=void 0}async initNewThread(){this.resetConversation()}async doSendMessage(t){try{if(!this.sdk)throw new r("Gemini API not initialized",e.ErrorCode.SERVICE_UNAVAILABLE);if(!this.conversationContext){const e=this.sdk.getGenerativeModel({model:"gemini-pro"}).startChat();this.conversationContext={chatSession:e}}const s=await this.conversationContext.chatSession.sendMessageStream(t.prompt);let n="";for await(const e of s.stream){n+=e.text(),t.onEvent({type:"UPDATE_ANSWER",data:{text:n}})}n||t.onEvent({type:"UPDATE_ANSWER",data:{text:"Empty response"}}),t.onEvent({type:"DONE"})}catch(t){if(t instanceof r)throw t;if(t instanceof DOMException&&"AbortError"===t.name)return;throw new r(t instanceof Error?t.message:String(t),e.ErrorCode.NETWORK_ERROR)}}},e.OpenRouterModel=class extends m{constructor(e){super(),this.apiKey=e.apiKey,this.model=e.model}getName(){return`OpenRouter/${this.model}`}supportsImageInput(){return!1}resetConversation(){this.conversationContext=void 0}buildMessages(e){return[...this.conversationContext.messages.slice(-10),{role:"user",content:e}]}async doSendMessage(t){try{if(!this.apiKey)throw new r("OpenRouter API key is required",e.ErrorCode.MISSING_API_KEY);this.conversationContext||(this.conversationContext={messages:[]});const s=this.buildMessages(t.prompt),n=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",signal:t.signal,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,"HTTP-Referer":"URL","X-Title":"TITLE"},body:JSON.stringify({model:this.model,messages:s,stream:!0})});if(!n.ok){const t=await n.json().catch((()=>({})));throw new r(t.error?.message||`HTTP error ${n.status}`,401===n.status?e.ErrorCode.UNAUTHORIZED:e.ErrorCode.SERVICE_UNAVAILABLE)}this.conversationContext.messages.push({role:"user",content:t.prompt});let o=!1;const a={role:"assistant",content:""},i=()=>{o=!0,t.onEvent({type:"DONE"});this.conversationContext.messages.push(a)};await h(n,(e=>{if("[DONE]"===e)return void i();let r;try{r=JSON.parse(e)}catch(e){return void console.error(e)}if(r?.choices?.length){const e=r.choices[0].delta;e?.content&&(a.content+=e.content,t.onEvent({type:"UPDATE_ANSWER",data:{text:a.content}}))}})),o||i()}catch(t){if(t instanceof r)throw t;if(t instanceof DOMException&&"AbortError"===t.name)return;throw new r(t instanceof Error?t.message:String(t),e.ErrorCode.NETWORK_ERROR)}}async initNewThread(){this.resetConversation()}},e.file2base64=p,e.parseSSEResponse=h,e.streamAsyncIterable=u}));
//# sourceMappingURL=ai-models-bridge.min.js.map
