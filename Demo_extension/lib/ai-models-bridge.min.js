var AIModelsBridge=function(e){"use strict";var t;e.ErrorCode=void 0,(t=e.ErrorCode||(e.ErrorCode={})).UNKNOWN_ERROR="unknown_error",t.NETWORK_ERROR="network_error",t.UNAUTHORIZED="unauthorized",t.SERVICE_UNAVAILABLE="service_unavailable",t.MISSING_API_KEY="missing_api_key",t.MISSING_HOST_PERMISSION="missing_host_permission",t.CONVERSATION_LIMIT="conversation_limit",t.CONTENT_FILTERED="content_filtered",t.INVALID_REQUEST="invalid_request",t.INVALID_API_KEY="invalid_api_key",t.INVALID_THREAD_ID="invalid_thread_id",t.INVALID_MESSAGE_ID="invalid_message_id",t.INVALID_MODEL="invalid_model",t.INVALID_IMAGE_TYPE="invalid_image_type",t.INVALID_IMAGE_CONTENT="invalid_image_content",t.UPLOAD_FAILED="upload_failed",t.UPLOAD_TIMEOUT="upload_timeout",t.UPLOAD_SIZE_EXCEEDED="upload_size_exceeded",t.UPLOAD_TYPE_EXCEEDED="upload_type_exceeded",t.UPLOAD_AMOUNT_EXCEEDED="upload_amount_exceeded",t.UPLOAD_TYPE_NOT_SUPPORTED="upload_type_not_supported",t.RATE_LIMIT_EXCEEDED="rate_limit_exceeded",t.METADATA_INITIALIZATION_ERROR="metadata_initialization_error",t.FEATURE_NOT_SUPPORTED="feature_not_supported";class r extends Error{constructor(t,r=e.ErrorCode.UNKNOWN_ERROR){super(t),this.code=r,this.name="AIModelError"}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;function a(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var o={exports:{}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self&&self,function(e){if(!globalThis.chrome?.runtime?.id)throw new Error("This script should only be loaded in a browser extension.");if(void 0===globalThis.browser||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const t="The message port closed before a response was received.",r=e=>{const r={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(0===Object.keys(r).length)throw new Error("api-metadata.json has not been included in browser-polyfill");class a extends WeakMap{constructor(e,t=void 0){super(t),this.createItem=e}get(e){return this.has(e)||this.set(e,this.createItem(e)),super.get(e)}}const o=e=>e&&"object"==typeof e&&"function"==typeof e.then,s=(t,r)=>(...a)=>{e.runtime.lastError?t.reject(new Error(e.runtime.lastError.message)):r.singleCallbackArg||a.length<=1&&!1!==r.singleCallbackArg?t.resolve(a[0]):t.resolve(a)},n=e=>1==e?"argument":"arguments",i=(e,t)=>function(r,...a){if(a.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${n(t.minArgs)} for ${e}(), got ${a.length}`);if(a.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${n(t.maxArgs)} for ${e}(), got ${a.length}`);return new Promise(((o,n)=>{if(t.fallbackToNoCallback)try{r[e](...a,s({resolve:o,reject:n},t))}catch(s){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,s),r[e](...a),t.fallbackToNoCallback=!1,t.noCallback=!0,o()}else t.noCallback?(r[e](...a),o()):r[e](...a,s({resolve:o,reject:n},t))}))},d=(e,t,r)=>new Proxy(t,{apply:(t,a,o)=>r.call(a,e,...o)});let l=Function.call.bind(Object.prototype.hasOwnProperty);const c=(e,t={},r={})=>{let a=Object.create(null),o={has:(t,r)=>r in e||r in a,get(o,s,n){if(s in a)return a[s];if(!(s in e))return;let g=e[s];if("function"==typeof g)if("function"==typeof t[s])g=d(e,e[s],t[s]);else if(l(r,s)){let t=i(s,r[s]);g=d(e,e[s],t)}else g=g.bind(e);else if("object"==typeof g&&null!==g&&(l(t,s)||l(r,s)))g=c(g,t[s],r[s]);else{if(!l(r,"*"))return Object.defineProperty(a,s,{configurable:!0,enumerable:!0,get:()=>e[s],set(t){e[s]=t}}),g;g=c(g,t[s],r["*"])}return a[s]=g,g},set:(t,r,o,s)=>(r in a?a[r]=o:e[r]=o,!0),defineProperty:(e,t,r)=>Reflect.defineProperty(a,t,r),deleteProperty:(e,t)=>Reflect.deleteProperty(a,t)},s=Object.create(e);return new Proxy(s,o)},g=e=>({addListener(t,r,...a){t.addListener(e.get(r),...a)},hasListener:(t,r)=>t.hasListener(e.get(r)),removeListener(t,r){t.removeListener(e.get(r))}}),h=new a((e=>"function"!=typeof e?e:function(t){const r=c(t,{},{getContent:{minArgs:0,maxArgs:0}});e(r)})),m=new a((e=>"function"!=typeof e?e:function(t,r,a){let s,n,i=!1,d=new Promise((e=>{s=function(t){i=!0,e(t)}}));try{n=e(t,r,s)}catch(e){n=Promise.reject(e)}const l=!0!==n&&o(n);if(!0!==n&&!l&&!i)return!1;const c=e=>{e.then((e=>{a(e)}),(e=>{let t;t=e&&(e instanceof Error||"string"==typeof e.message)?e.message:"An unexpected error occurred",a({__mozWebExtensionPolyfillReject__:!0,message:t})})).catch((e=>{console.error("Failed to send onMessage rejected reply",e)}))};return c(l?n:d),!0})),u=({reject:r,resolve:a},o)=>{e.runtime.lastError?e.runtime.lastError.message===t?a():r(new Error(e.runtime.lastError.message)):o&&o.__mozWebExtensionPolyfillReject__?r(new Error(o.message)):a(o)},p=(e,t,r,...a)=>{if(a.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${n(t.minArgs)} for ${e}(), got ${a.length}`);if(a.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${n(t.maxArgs)} for ${e}(), got ${a.length}`);return new Promise(((e,t)=>{const o=u.bind(null,{resolve:e,reject:t});a.push(o),r.sendMessage(...a)}))},A={devtools:{network:{onRequestFinished:g(h)}},runtime:{onMessage:g(m),onMessageExternal:g(m),sendMessage:p.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:p.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},E={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return r.privacy={network:{"*":E},services:{"*":E},websites:{"*":E}},c(e,A,r)};e.exports=r(chrome)}else e.exports=globalThis.browser}(o);var s=a(o.exports);let n;const i=new Uint8Array(16);function d(){if(!n&&(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(i)}const l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));var c={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function g(e,t,r){if(c.randomUUID&&!e)return c.randomUUID();const a=(e=e||{}).random||(e.rng||d)();return a[6]=15&a[6]|64,a[8]=63&a[8]|128,function(e,t=0){return l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]}(a)}class h{constructor(){this.baseUrl="",this.models={},this.defaultModel=""}async sendMessage(e,t={onEvent:()=>{}}){try{let r="";return await this.doSendMessage({prompt:e,image:t.image,signal:t.signal,mode:t.mode,model:t.model,style_key:t.style_key,onEvent:e=>{"UPDATE_ANSWER"===e.type&&(r=e.data.text,t.onEvent({type:"UPDATE_ANSWER",data:{text:r}})),"DONE"===e.type&&t.onEvent({type:"DONE",data:e.data}),"SUGGESTED_RESPONSES"===e.type&&t.onEvent({type:"SUGGESTED_RESPONSES",data:e.data}),"TITLE_UPDATE"===e.type&&t.onEvent({type:"TITLE_UPDATE",data:e.data})}}),r}catch(e){if(e instanceof r)throw e;throw new r(e instanceof Error?e.message:String(e))}}async getAllThreads(){try{return(await s.storage.local.get(h.THREADS_STORAGE_KEY))[h.THREADS_STORAGE_KEY]||[]}catch(e){return console.error("Failed to load threads from storage:",e),[]}}async saveThreadsToStorage(e){try{await s.storage.local.set({[h.THREADS_STORAGE_KEY]:e})}catch(e){console.error("Failed to save threads to storage:",e)}}getCurrentThread(){return this.currentThread}async loadThread(e){const t=(await this.getAllThreads()).find((t=>t.id===e));if(!t)throw new Error("Thread not found");this.currentThread=t}async saveThread(){if(!this.currentThread)throw new Error("No active thread to save");const e=await this.getAllThreads(),t=e.findIndex((e=>e.id===this.currentThread.id));-1!==t?e[t]=this.currentThread:e.push(this.currentThread),await this.saveThreadsToStorage(e)}async deleteThread(e){const t=await this.getAllThreads();await this.saveThreadsToStorage(t.filter((t=>t.id!==e))),this.currentThread?.id===e&&this.initNewThread()}createMessage(e,t){return{id:g(),role:e,content:t,timestamp:Date.now()}}getBaseUrl(){return this.baseUrl}handleModelError(t,a=e.ErrorCode.UNKNOWN_ERROR,o,s){const n=s?s instanceof r||s instanceof Error?s.message:String(s):t,i=new r(s?`${n} - Description: ${t}.`:t,a);throw o&&o.onEvent({type:"ERROR",error:i}),console.error("AI model error:",i),i}async shareConversation(t){throw new r(`Sharing is not supported by the ${this.getName()} model`,e.ErrorCode.FEATURE_NOT_SUPPORTED)}}h.THREADS_STORAGE_KEY="chat_threads";const m={TOKEN_REFRESH_START:"token_refresh_start",TOKEN_REFRESH_COMPLETE:"token_refresh_complete",TOKEN_REFRESH_ERROR:"token_refresh_error"},u={},p=3e5;let A=!0;function E(e,t={}){if(A){const r=new CustomEvent(e,{detail:{...t,timestamp:Date.now()},bubbles:!0});document.dispatchEvent(r)}}async function f(e=!1){try{if(!e&&u.copilot&&u.copilot.token&&u.copilot.expiresAt>Date.now()+p)return console.log("Using cached Copilot auth token"),u.copilot.token;if(!e&&u.copilot&&u.copilot.token&&u.copilot.expiresAt>Date.now())return console.log("Token about to expire, triggering background refresh"),setTimeout((()=>{E(m.TOKEN_REFRESH_START,{background:!0}),w().then((()=>{E(m.TOKEN_REFRESH_COMPLETE,{background:!0})})).catch((e=>{console.error("Background token refresh failed:",e),E(m.TOKEN_REFRESH_ERROR,{background:!0,error:e.message})}))}),0),u.copilot.token;console.log("Getting new Copilot auth token"),E(m.TOKEN_REFRESH_START,{background:!1});try{const e=await w();if(E(m.TOKEN_REFRESH_COMPLETE,{background:!1}),e)return e}catch(e){throw E(m.TOKEN_REFRESH_ERROR,{background:!1,error:e instanceof Error?e.message:"Unknown error"}),e}return console.error("Failed to get Copilot token"),null}catch(e){return console.error("Error getting Copilot auth token:",e),null}}async function w(){if(void 0===s||!s.tabs||!s.windows)throw new Error("Tab method requires browser extension APIs");let e=null;try{e=await s.windows.create({url:"https://copilot.microsoft.com/",focused:!1,type:"popup",width:100,height:100,left:0,top:0});const t=e.tabs?.[0]?.id;if(!t)throw new Error("Failed to get tab ID from new window");await new Promise((e=>setTimeout(e,5e3)));const r=await s.scripting.executeScript({target:{tabId:t},func:()=>{for(let e=0;e<localStorage.length;e++)try{const t=localStorage.key(e);if(!t)continue;const r=JSON.parse(localStorage.getItem(t)||"");if("AccessToken"===r.credentialType&&r.expiresOn>Math.floor(Date.now()/1e3)&&r.target?.includes("ChatAI"))return{token:r.secret,expiresAt:1e3*r.expiresOn}}catch(e){}return null}}),a=r?.[0]?.result;return a?.token?(u.copilot={token:a.token,cookies:{},timestamp:Date.now(),expiresAt:a.expiresAt||Date.now()+18e5},a.token):null}catch(e){return console.error("Error getting token via tab:",e),null}finally{if(e?.id)try{await s.windows.remove(e.id)}catch(e){console.error("Error closing auth window:",e)}}}const y=/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,T=/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,v=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/;function x(e,t){if(!("__proto__"===e||"constructor"===e&&t&&"object"==typeof t&&"prototype"in t))return t;!function(e){console.warn(`[destr] Dropping "${e}" key to prevent prototype pollution.`)}(e)}function I(e,t={}){if("string"!=typeof e)return e;const r=e.trim();if('"'===e[0]&&e.endsWith('"')&&!e.includes("\\"))return r.slice(1,-1);if(r.length<=9){const e=r.toLowerCase();if("true"===e)return!0;if("false"===e)return!1;if("undefined"===e)return;if("null"===e)return null;if("nan"===e)return Number.NaN;if("infinity"===e)return Number.POSITIVE_INFINITY;if("-infinity"===e)return Number.NEGATIVE_INFINITY}if(!v.test(e)){if(t.strict)throw new SyntaxError("[destr] Invalid JSON");return e}try{if(y.test(e)||T.test(e)){if(t.strict)throw new Error("[destr] Possible prototype pollution");return JSON.parse(e,x)}return JSON.parse(e)}catch(r){if(t.strict)throw r;return e}}const S=/#/g,b=/&/g,R=/\//g,N=/=/g,_=/\+/g,C=/%5e/gi,O=/%60/gi,U=/%7c/gi,D=/%20/gi;function k(e){return(t="string"==typeof e?e:JSON.stringify(e),encodeURI(""+t).replace(U,"|")).replace(_,"%2B").replace(D,"+").replace(S,"%23").replace(b,"%26").replace(O,"`").replace(C,"^").replace(R,"%2F");var t}function L(e){return k(e).replace(N,"%3D")}function M(e=""){try{return decodeURIComponent(""+e)}catch{return""+e}}function P(e){return M(e.replace(_," "))}function V(e=""){const t={};"?"===e[0]&&(e=e.slice(1));for(const r of e.split("&")){const e=r.match(/([^=]+)=?(.*)/)||[];if(e.length<2)continue;const a=M(e[1].replace(_," "));if("__proto__"===a||"constructor"===a)continue;const o=P(e[2]||"");void 0===t[a]?t[a]=o:Array.isArray(t[a])?t[a].push(o):t[a]=[t[a],o]}return t}function $(e){return Object.keys(e).filter((t=>void 0!==e[t])).map((t=>{return r=t,"number"!=typeof(a=e[t])&&"boolean"!=typeof a||(a=String(a)),a?Array.isArray(a)?a.map((e=>`${L(r)}=${k(e)}`)).join("&"):`${L(r)}=${k(a)}`:L(r);var r,a})).filter(Boolean).join("&")}const F=/^[\s\w\0+.-]{2,}:([/\\]{1,2})/,z=/^[\s\w\0+.-]{2,}:([/\\]{2})?/,B=/^([/\\]\s*){2,}[^/\\]/,j=/^\.?\//;function W(e,t={}){return"boolean"==typeof t&&(t={acceptRelative:t}),t.strict?F.test(e):z.test(e)||!!t.acceptRelative&&B.test(e)}function q(e="",t){return e.endsWith("/")?e:e+"/"}function H(e,t){if(!(r=t)||"/"===r||W(e))return e;var r;const a=function(e=""){return(function(e=""){return e.endsWith("/")}(e)?e.slice(0,-1):e)||"/"}(t);return e.startsWith(a)?e:function(e,...t){let r=e||"";for(const e of t.filter((e=>function(e){return e&&"/"!==e}(e))))if(r){const t=e.replace(j,"");r=q(r)+t}else r=e;return r}(a,e)}function K(e,t){const r=function(e=""){const t=e.match(/^[\s\0]*(blob:|data:|javascript:|vbscript:)(.*)/i);if(t){const[,e,r=""]=t;return{protocol:e.toLowerCase(),pathname:r,href:e+r,auth:"",host:"",search:"",hash:""}}if(!W(e,{acceptRelative:!0}))return J(e);const[,r="",a,o=""]=e.replace(/\\/g,"/").match(/^[\s\0]*([\w+.-]{2,}:)?\/\/([^/@]+@)?(.*)/)||[];let[,s="",n=""]=o.match(/([^#/?]*)(.*)?/)||[];"file:"===r&&(n=n.replace(/\/(?=[A-Za-z]:)/,""));const{pathname:i,search:d,hash:l}=J(n);return{protocol:r.toLowerCase(),auth:a?a.slice(0,Math.max(0,a.length-1)):"",host:s,pathname:i,search:d,hash:l,[G]:!r}}(e),a={...V(r.search),...t};return r.search=$(a),function(e){const t=e.pathname||"",r=e.search?(e.search.startsWith("?")?"":"?")+e.search:"",a=e.hash||"",o=e.auth?e.auth+"@":"",s=e.host||"",n=e.protocol||e[G]?(e.protocol||"")+"//":"";return n+o+s+t+r+a}(r)}const G=Symbol.for("ufo:protocolRelative");function J(e=""){const[t="",r="",a=""]=(e.match(/([^#?]*)(\?[^#]*)?(#.*)?/)||[]).splice(1);return{pathname:t,search:r,hash:a}}class Z extends Error{constructor(e,t){super(e,t),this.name="FetchError",t?.cause&&!this.cause&&(this.cause=t.cause)}}const Q=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function Y(e="GET"){return Q.has(e.toUpperCase())}const X=new Set(["image/svg","application/xml","application/xhtml","application/html"]),ee=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function te(e,t,r,a){const o=function(e,t,r){if(!t)return new r(e);const a=new r(t);if(e)for(const[t,o]of Symbol.iterator in e||Array.isArray(e)?e:new r(e))a.set(t,o);return a}(t?.headers??e?.headers,r?.headers,a);let s;return(r?.query||r?.params||t?.params||t?.query)&&(s={...r?.params,...r?.query,...t?.params,...t?.query}),{...r,...t,query:s,params:s,headers:o}}async function re(e,t){if(t)if(Array.isArray(t))for(const r of t)await r(e);else await t(e)}const ae=new Set([408,409,425,429,500,502,503,504]),oe=new Set([101,204,205,304]);const se=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),ne=function e(t={}){const{fetch:r=globalThis.fetch,Headers:a=globalThis.Headers,AbortController:o=globalThis.AbortController}=t;async function s(e){const t=e.error&&"AbortError"===e.error.name&&!e.options.timeout||!1;if(!1!==e.options.retry&&!t){let t;t="number"==typeof e.options.retry?e.options.retry:Y(e.options.method)?0:1;const r=e.response&&e.response.status||500;if(t>0&&(Array.isArray(e.options.retryStatusCodes)?e.options.retryStatusCodes.includes(r):ae.has(r))){const r="function"==typeof e.options.retryDelay?e.options.retryDelay(e):e.options.retryDelay||0;return r>0&&await new Promise((e=>setTimeout(e,r))),n(e.request,{...e.options,retry:t-1})}}const r=function(e){const t=e.error?.message||e.error?.toString()||"",r=e.request?.method||e.options?.method||"GET",a=e.request?.url||String(e.request)||"/",o=`[${r}] ${JSON.stringify(a)}`,s=e.response?`${e.response.status} ${e.response.statusText}`:"<no response>",n=new Z(`${o}: ${s}${t?` ${t}`:""}`,e.error?{cause:e.error}:void 0);for(const t of["request","options","response"])Object.defineProperty(n,t,{get:()=>e[t]});for(const[t,r]of[["data","_data"],["status","status"],["statusCode","status"],["statusText","statusText"],["statusMessage","statusText"]])Object.defineProperty(n,t,{get:()=>e.response&&e.response[r]});return n}(e);throw Error.captureStackTrace&&Error.captureStackTrace(r,n),r}const n=async function(e,n={}){const i={request:e,options:te(e,n,t.defaults,a),response:void 0,error:void 0};let d;if(i.options.method&&(i.options.method=i.options.method.toUpperCase()),i.options.onRequest&&await re(i,i.options.onRequest),"string"==typeof i.request&&(i.options.baseURL&&(i.request=H(i.request,i.options.baseURL)),i.options.query&&(i.request=K(i.request,i.options.query),delete i.options.query),"query"in i.options&&delete i.options.query,"params"in i.options&&delete i.options.params),i.options.body&&Y(i.options.method)&&(!function(e){if(void 0===e)return!1;const t=typeof e;return"string"===t||"number"===t||"boolean"===t||null===t||"object"===t&&(!!Array.isArray(e)||!e.buffer&&(e.constructor&&"Object"===e.constructor.name||"function"==typeof e.toJSON))}(i.options.body)?("pipeTo"in i.options.body&&"function"==typeof i.options.body.pipeTo||"function"==typeof i.options.body.pipe)&&("duplex"in i.options||(i.options.duplex="half")):(i.options.body="string"==typeof i.options.body?i.options.body:JSON.stringify(i.options.body),i.options.headers=new a(i.options.headers||{}),i.options.headers.has("content-type")||i.options.headers.set("content-type","application/json"),i.options.headers.has("accept")||i.options.headers.set("accept","application/json"))),!i.options.signal&&i.options.timeout){const e=new o;d=setTimeout((()=>{const t=new Error("[TimeoutError]: The operation was aborted due to timeout");t.name="TimeoutError",t.code=23,e.abort(t)}),i.options.timeout),i.options.signal=e.signal}try{i.response=await r(i.request,i.options)}catch(e){return i.error=e,i.options.onRequestError&&await re(i,i.options.onRequestError),await s(i)}finally{d&&clearTimeout(d)}if((i.response.body||i.response._bodyInit)&&!oe.has(i.response.status)&&"HEAD"!==i.options.method){const e=(i.options.parseResponse?"json":i.options.responseType)||function(e=""){if(!e)return"json";const t=e.split(";").shift()||"";return ee.test(t)?"json":X.has(t)||t.startsWith("text/")?"text":"blob"}(i.response.headers.get("content-type")||"");switch(e){case"json":{const e=await i.response.text(),t=i.options.parseResponse||I;i.response._data=t(e);break}case"stream":i.response._data=i.response.body||i.response._bodyInit;break;default:i.response._data=await i.response[e]()}}return i.options.onResponse&&await re(i,i.options.onResponse),!i.options.ignoreResponseError&&i.response.status>=400&&i.response.status<600?(i.options.onResponseError&&await re(i,i.options.onResponseError),await s(i)):i.response},i=async function(e,t){return(await n(e,t))._data};return i.raw=n,i.native=(...e)=>r(...e),i.create=(r={},a={})=>e({...t,...a,defaults:{...t.defaults,...a.defaults,...r}}),i}({fetch:se.fetch?(...e)=>se.fetch(...e):()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!")),Headers:se.Headers,AbortController:se.AbortController});function ie(e,t){const r=new RegExp(`"${e}":"([^"]+)"`).exec(t);return r?.[1]}var de=null;"undefined"!=typeof WebSocket?de=WebSocket:"undefined"!=typeof MozWebSocket?de=MozWebSocket:"undefined"!=typeof global?de=global.WebSocket||global.MozWebSocket:"undefined"!=typeof window?de=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(de=self.WebSocket||self.MozWebSocket);var le=de;async function ce(e){const t={origins:[e]};try{return!!await s.permissions.contains(t)||await s.permissions.request(t)}catch(e){return console.error("Error requesting permissions:",e),!1}}function ge(e,t,r,a){var o,s=arguments.length,n=s<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,a);else for(var i=e.length-1;i>=0;i--)(o=e[i])&&(n=(s<3?o(n):s>3?o(t,r,n):o(t,r))||n);return s>3&&n&&Object.defineProperty(t,r,n),n}function he(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function me(e,t,r){return r}"function"==typeof SuppressedError&&SuppressedError;class ue extends h{constructor(e={}){super(),this.sessionKey=e.sessionKey,this.initializeStorage().catch(console.error)}async initializeStorage(){(await this.getAllThreads()).length||await this.saveThreadsToStorage([]),await this.validateExistingThreads()}async validateExistingThreads(){const e=await this.getAllThreads();let t=!1;for(const r of e)r.modelName!==this.getName()||this.isValidClaudeMetadata(r.metadata)||(await this.deleteThread(r.id),t=!0);t&&await this.saveThreadsToStorage(e.filter((e=>e.modelName!==this.getName()||this.isValidClaudeMetadata(e.metadata))))}isValidClaudeMetadata(e){return e?.organizationId&&e?.conversationId}getName(){return"Claude Web"}supportsImageInput(){return!0}async createConversation(t){const r=g();try{await ne(`https://claude.ai/api/organizations/${t}/chat_conversations`,{method:"POST",headers:this.getHeaders(),credentials:"include",body:{name:"",uuid:r}});return r}catch(t){if(t instanceof Z&&403===t.status)throw this.handleModelError("There is no logged-in Claude account in this browser.",e.ErrorCode.UNAUTHORIZED,void 0,t);throw this.handleModelError("Failed to create conversation",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}async generateChatTitle(e,t,r){try{const a=await ne(`https://claude.ai/api/organizations/${e}/chat_conversations/${t}/title`,{method:"POST",headers:this.getHeaders(),credentials:"include",body:{message_content:r,recent_titles:[]}});return a.title?a.title:"New Conversation"}catch(e){return console.error("Failed to generate chat title:",e),"New Conversation"}}getHeaders(){const e={"Content-Type":"application/json",Accept:"application/json"};return this.sessionKey&&(e.Cookie=`sessionKey=${this.sessionKey}`),e}async ensureThreadLoaded(){if(!this.currentThread){const e=(await this.getAllThreads()).filter((e=>e.modelName===this.getName()&&this.isValidClaudeMetadata(e.metadata)));if(e.length>0){const t=e.sort(((e,t)=>t.updatedAt-e.updatedAt))[0];this.currentThread=t,console.log("Loaded existing thread from storage:",this.currentThread.id)}else await this.initNewThread()}}getClaudeMetadata(){const t=this.getCurrentThreadSafe();if(!t.metadata)throw this.handleModelError("No thread metadata available",e.ErrorCode.INVALID_REQUEST);const r=t.metadata;if(!r.organizationId||!r.conversationId)throw this.handleModelError("Invalid thread metadata",e.ErrorCode.INVALID_REQUEST);return r}getCurrentThreadSafe(){if(!this.currentThread)throw this.handleModelError("No active thread",e.ErrorCode.INVALID_REQUEST);return this.currentThread}async initNewThread(){try{const t=await this.getOrganizationId();if(!t)throw this.handleModelError("Organization ID is required",e.ErrorCode.INVALID_REQUEST);const r=await this.createConversation(t);this.currentThread={id:r,title:"New Conversation",modelName:this.getName(),messages:[],createdAt:Date.now(),updatedAt:Date.now(),metadata:{organizationId:t,conversationId:r}},await this.saveThread()}catch(t){throw this.handleModelError("Error initializing new thread",e.ErrorCode.METADATA_INITIALIZATION_ERROR,void 0,t)}}async loadThread(t){const r=(await this.getAllThreads()).find((e=>e.id===t));if(!r||r.modelName!==this.getName())throw this.handleModelError(`Thread ${t} not found`,e.ErrorCode.INVALID_THREAD_ID);this.currentThread=r,!this.organizationId&&r.metadata&&(this.organizationId=r.metadata.organizationId)}async doSendMessage(t){try{t.onEvent({type:"UPDATE_ANSWER",data:{text:""}}),await this.ensureThreadLoaded();const r=this.getCurrentThreadSafe(),a=this.getClaudeMetadata(),o=this.createMessage("user",t.prompt);t.image&&(o.metadata={imageDataUrl:await this.fileToDataUrl(t.image)}),r.messages.push(o);let s={};if(t.image){const r=new FormData;r.append("file",t.image);const o=await fetch(`https://claude.ai/api/${a.organizationId}/upload`,{method:"POST",body:r});if(!o.ok)throw this.handleModelError("Failed to upload image",e.ErrorCode.UPLOAD_FAILED,t,o);s=await o.json()}let n=await this.getStyles(a.organizationId),i=this.findStyleByKey(n,t.style_key||"");t.style_key&&!i&&console.warn(`Style key '${t.style_key}' not found, using default style.`);const d=await fetch(`https://claude.ai/api/organizations/${a.organizationId}/chat_conversations/${a.conversationId}/completion`,{method:"POST",headers:this.getHeaders(),credentials:"include",signal:t.signal,body:JSON.stringify({attachments:[],files:s&&s.file_uuid?[s.file_uuid]:[],locale:navigator.language||"en-US",personalized_styles:i?[i]:[],prompt:t.prompt,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone})});if(!d.ok){const r=await d.text();try{const a=JSON.parse(r);if(429===d.status&&"error"===a.type&&"rate_limit_error"===a.error?.type)try{a.error.message=JSON.parse(a.error.message);let r="";if(a.error.resetsAt){const e=new Date(1e3*a.error.resetsAt);a.error.resetsAt.resetsAtReadable=e.toLocaleString(),r=` Rate limit resets at ${a.error.resetsAt.resetsAtReadable}`}throw this.handleModelError(`Claude rate limit exceeded.${r}`,e.ErrorCode.RATE_LIMIT_EXCEEDED,t,a)}catch(r){throw this.handleModelError(`Claude rate limit exceeded: ${a.error.message}`,e.ErrorCode.RATE_LIMIT_EXCEEDED,t,a)}throw this.handleModelError(`Claude API error: ${JSON.stringify(a)}`,e.ErrorCode.SERVICE_UNAVAILABLE,t)}catch(a){throw 429===d.status?this.handleModelError("Claude rate limit exceeded. Please try again later.",e.ErrorCode.RATE_LIMIT_EXCEEDED,t):this.handleModelError(`Claude API error: ${d.status} - ${r.substring(0,200)}`,e.ErrorCode.SERVICE_UNAVAILABLE,t)}}if(!d.body)throw this.handleModelError("Response body is null",e.ErrorCode.SERVICE_UNAVAILABLE,t);const l=d.body.getReader(),c=new TextDecoder;let g="",h="",m="",u="";for(;;){const{done:e,value:r}=await l.read();if(e)break;g+=c.decode(r,{stream:!0});const a=g.split("\n");g=a.pop()||"";for(const e of a)if(e.trim())e.startsWith("event:")?m=e.substring(6).trim():e.startsWith("data:")&&(u=e.substring(5).trim());else if(m&&u){const e=this.processEvent(m,u,h);null!==e&&(h=e,t.onEvent({type:"UPDATE_ANSWER",data:{text:h}})),m="",u=""}}if(g.trim()){const e=g.split("\n");for(const r of e)if(r.startsWith("event:"))m=r.substring(6).trim();else if(r.startsWith("data:")&&(u=r.substring(5).trim(),m&&u)){const e=this.processEvent(m,u,h);null!==e&&(h=e,t.onEvent({type:"UPDATE_ANSWER",data:{text:h}}))}}const p=this.createMessage("assistant",h);if(r.messages.push(p),r.updatedAt=Date.now(),"New Conversation"===r.title&&r.messages.length<=2){const e=await this.generateChatTitle(a.organizationId,a.conversationId,t.prompt);r.title=e,t.onEvent({type:"TITLE_UPDATE",data:{title:e,threadId:r.id}})}await this.saveThread(),t.onEvent({type:"DONE",data:{threadId:r.id}})}catch(r){this.handleModelError("Error sending message",e.ErrorCode.SERVICE_UNAVAILABLE,t,r)}}processEvent(t,r,a,o){if(!t||!r)return null;try{switch(t){case"completion":const s=JSON.parse(r);if(s.completion)return a+s.completion;break;case"error":const n=JSON.parse(r);if("rate_limit_error"!==n.type)throw this.handleModelError(n.error||n.message||"Unknown Claude error",n.error||n.message?e.ErrorCode.SERVICE_UNAVAILABLE:e.ErrorCode.UNKNOWN_ERROR,o||void 0,n);try{n.message=JSON.parse(n.message);let t="";if(n.resetsAt){const e=new Date(1e3*n.resetsAt);n.resetsAt.resetsAtReadable=e.toLocaleString(),t=` Rate limit resets at ${n.resetsAt.resetsAtReadable}`}throw this.handleModelError(`Claude rate limit exceeded.${t}`,e.ErrorCode.RATE_LIMIT_EXCEEDED,o||void 0,n)}catch(t){throw this.handleModelError(`Claude rate limit exceeded: ${n.message}`,e.ErrorCode.RATE_LIMIT_EXCEEDED,o||void 0,n)}case"ping":return null;default:return console.log(`Unhandled event type: ${t}`,r),null}}catch(r){console.warn(`Error processing ${t} event:`,r),this.handleModelError(`Error processing ${t} event`,e.ErrorCode.UNKNOWN_ERROR,o,r)}return null}async fileToDataUrl(e){return new Promise(((t,r)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=r,a.readAsDataURL(e)}))}async editTitle(t,r){try{let a,o=!1!==r?.loadThread,s=!1!==r?.tryUpdateThread;if(r?.metadata&&(o=!1),o)await this.ensureThreadLoaded(),a=this.getClaudeMetadata();else{if(!r?.metadata)throw this.handleModelError("No thread loaded and no metadata provided for sharing",e.ErrorCode.INVALID_REQUEST);if(a=r.metadata,!a.organizationId||!a.conversationId)throw this.handleModelError("Invalid metadata provided for sharing",e.ErrorCode.INVALID_REQUEST)}const n=await fetch(`https://claude.ai/api/organizations/${a.organizationId}/chat_conversations/${a.conversationId}`,{method:"PUT",headers:this.getHeaders(),credentials:"include",body:JSON.stringify({name:t})});if(!n.ok)throw this.handleModelError(`Failed to update title: ${n.status}`,e.ErrorCode.SERVICE_UNAVAILABLE,void 0,await n.text());s&&this.currentThread&&(this.currentThread.title=t,await this.saveThread())}catch(t){throw this.handleModelError("Error updating conversation title",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}async deleteServerThread(t,r=!0,a){try{if(a||(a=await this.getOrganizationId()),!a||!t)throw this.handleModelError("Invalid metadata provided for request",e.ErrorCode.INVALID_REQUEST);const o=await fetch(`https://claude.ai/api/organizations/${a}/chat_conversations/delete_many`,{method:"POST",headers:this.getHeaders(),credentials:"include",body:JSON.stringify({conversation_uuids:t})});if(!o.ok)throw this.handleModelError(`Failed to get conversation: ${o.status}`,e.ErrorCode.SERVICE_UNAVAILABLE,void 0,await o.text());let s=await o.json();if(r)for(let e of t)await this.deleteThread(e);return s}catch(t){throw this.handleModelError("Error deleting conversation(s)",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}async shareConversation(t){try{let r,a=!1!==t?.loadThread;if(t?.metadata&&(a=!1),a)await this.ensureThreadLoaded(),r=this.getClaudeMetadata();else{if(!t?.metadata)throw this.handleModelError("No thread loaded and no metadata provided for sharing",e.ErrorCode.INVALID_REQUEST);if(r=t.metadata,!r.organizationId||!r.conversationId)throw this.handleModelError("Invalid metadata provided for sharing",e.ErrorCode.INVALID_REQUEST)}const o=await fetch(`https://claude.ai/api/organizations/${r.organizationId}/chat_conversations/${r.conversationId}/share`,{method:"POST",headers:this.getHeaders(),credentials:"include",body:JSON.stringify({})});if(!o.ok){const t=await o.text();throw this.handleModelError(`Failed to share conversation: ${o.status}`,e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}const s=await o.json();if(!s.uuid)throw this.handleModelError("Share response did not contain a URL",e.ErrorCode.SERVICE_UNAVAILABLE);const n=`https://claude.ai/share/${s.uuid}`;return a&&this.currentThread&&this.currentThread.metadata&&(this.currentThread.metadata.shareUrl=n,await this.saveThread()),n}catch(t){throw this.handleModelError("Error sharing conversation",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}findStyleByKey(e,t){if(e&&Array.isArray(e.defaultStyles))for(let r=0;r<e.defaultStyles.length;r++)if(e.defaultStyles[r]&&e.defaultStyles[r].key===t)return e.defaultStyles[r];if(e&&Array.isArray(e.customStyles))for(let r=0;r<e.customStyles.length;r++)if(e.customStyles[r]&&e.customStyles[r].key===t)return e.customStyles[r]}async getStyles(t){t||(t=await this.getOrganizationId());const r=await fetch(`https://claude.ai/api/organizations/${t}/list_styles`,{method:"GET",headers:this.getHeaders(),credentials:"include"});if(!r.ok)throw this.handleModelError(`Failed to get styles: ${r.status}`,e.ErrorCode.SERVICE_UNAVAILABLE,void 0,await r.text());return await r.json()}async getConversationData(t){try{let r,a=!1!==t?.loadThread;if(t?.metadata&&(a=!1),a)await this.ensureThreadLoaded(),r=this.getClaudeMetadata();else{if(!t?.metadata)throw this.handleModelError("No thread loaded and no metadata provided for getting conversation",e.ErrorCode.INVALID_REQUEST);if(r=t.metadata,!r.organizationId||!r.conversationId)throw this.handleModelError("Invalid metadata provided for getting conversation",e.ErrorCode.INVALID_REQUEST)}const o=await fetch(`https://claude.ai/api/organizations/${r.organizationId}/chat_conversations/${r.conversationId}`,{method:"GET",headers:this.getHeaders(),credentials:"include"});if(!o.ok)throw this.handleModelError(`Failed to get conversation: ${o.status}`,e.ErrorCode.SERVICE_UNAVAILABLE,void 0,await o.text());return await o.json()}catch(t){throw this.handleModelError("Error getting conversation",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}async getAllConversationsData(t){t||(t=await this.getOrganizationId());try{const r=await fetch(`https://claude.ai/api/organizations/${t}/chat_conversations`,{method:"GET",headers:this.getHeaders(),credentials:"include",redirect:"error",cache:"no-cache"});if(!r.ok)throw this.handleModelError(`Failed to get conversations data: ${r.status}`,e.ErrorCode.SERVICE_UNAVAILABLE,void 0,await r.text());return await r.json()}catch(t){throw this.handleModelError("Error getting conversations",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}async getOrganizationData(t){t||(t=await this.getOrganizationId());try{const r=await fetch(`https://claude.ai/api/organizations/${t}`,{method:"GET",headers:this.getHeaders(),credentials:"include"});if(!r.ok)throw this.handleModelError(`Failed to get organization data: ${r.status}`,e.ErrorCode.SERVICE_UNAVAILABLE,void 0,await r.text());return await r.json()}catch(t){throw this.handleModelError("Error getting organization",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}async getAllOrganizationsData(){try{const t=await fetch("https://claude.ai/api/organizations",{method:"GET",headers:this.getHeaders(),credentials:"include",redirect:"error",cache:"no-cache"});if(403===t.status)throw this.handleModelError("There is no logged-in Claude account in this browser.",e.ErrorCode.UNAUTHORIZED);if(!t.ok)throw this.handleModelError(`Failed to get organization data: ${t.status}`,e.ErrorCode.SERVICE_UNAVAILABLE,void 0,await t.text());return await t.json()}catch(t){throw this.handleModelError("Error getting organization",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}async getOrganizationId(){if(this.organizationId)return this.organizationId;try{const t=await this.getAllOrganizationsData();if(!t||!t.length)throw this.handleModelError("No organizations found for Claude account",e.ErrorCode.UNAUTHORIZED);return this.organizationId=t[0].uuid,this.organizationId}catch(t){this.handleModelError("Claude webapp not available in your country or region",e.ErrorCode.SERVICE_UNAVAILABLE,void 0,t)}}}return ge([me,he("design:type",Function),he("design:paramtypes",[String,Object]),he("design:returntype",Promise)],ue.prototype,"editTitle",null),ge([me,he("design:type",Function),he("design:paramtypes",[Array,Boolean,Object]),he("design:returntype",Promise)],ue.prototype,"deleteServerThread",null),ge([me,he("design:type",Function),he("design:paramtypes",[Object]),he("design:returntype",Promise)],ue.prototype,"shareConversation",null),ge([me,he("design:type",Function),he("design:paramtypes",[String]),he("design:returntype",Promise)],ue.prototype,"getStyles",null),ge([me,he("design:type",Function),he("design:paramtypes",[Object]),he("design:returntype",Promise)],ue.prototype,"getConversationData",null),ge([me,he("design:type",Function),he("design:paramtypes",[String]),he("design:returntype",Promise)],ue.prototype,"getAllConversationsData",null),ge([me,he("design:type",Function),he("design:paramtypes",[String]),he("design:returntype",Promise)],ue.prototype,"getOrganizationData",null),ge([me,he("design:type",Function),he("design:paramtypes",[]),he("design:returntype",Promise)],ue.prototype,"getAllOrganizationsData",null),ge([me,he("design:type",Function),he("design:paramtypes",[]),he("design:returntype",Promise)],ue.prototype,"getOrganizationId",null),e.AIModelError=r,e.AUTH_EVENTS=m,e.AbstractModel=h,e.BardModel=class extends h{constructor(){super(),this.models={"gemini-2.0-flash":{"x-goog-ext-525001261-jspb":'[null,null,null,null,"f299729663a2343f"]'},"gemini-2.0-flash-exp":{"x-goog-ext-525001261-jspb":'[null,null,null,null,"f299729663a2343f"]'},"gemini-2.0-flash-thinking":{"x-goog-ext-525001261-jspb":'[null,null,null,null,"9c17b1863f581b8a"]'},"gemini-2.0-flash-thinking-with-apps":{"x-goog-ext-525001261-jspb":'[null,null,null,null,"f8f8f5ea629f5d37"]'},"gemini-2.0-exp-advanced":{"x-goog-ext-525001261-jspb":'[null,null,null,null,"b1e46a6037e6aa9f"]'},"gemini-1.5-flash":{"x-goog-ext-525001261-jspb":'[null,null,null,null,"418ab5ea040b5c43"]'},"gemini-1.5-pro":{"x-goog-ext-525001261-jspb":'[null,null,null,null,"9d60dfae93c9ff1f"]'},"gemini-1.5-pro-research":{"x-goog-ext-525001261-jspb":'[null,null,null,null,"e5a44cb1dae2b489"]'}},this.defaultModel="gemini-2.0-flash",this.initializeStorage().catch(console.error)}async initializeStorage(){(await this.getAllThreads()).length||await this.saveThreadsToStorage([]),await this.validateExistingThreads()}async validateExistingThreads(){const e=await this.getAllThreads();let t=!1;for(const r of e)r.modelName!==this.getName()||this.isValidBardMetadata(r.metadata)||(await this.deleteThread(r.id),t=!0);t&&await this.saveThreadsToStorage(e.filter((e=>e.modelName!==this.getName()||this.isValidBardMetadata(e.metadata))))}isValidBardMetadata(e){return e?.contextIds&&e?.requestParams}getName(){return"Google Bard"}supportsImageInput(){return!0}async fetchRequestParams(){try{const t=await ne("https://gemini.google.com/",{responseType:"text"}),a=ie("SNlM0e",t),o=ie("cfb2h",t);if(!a||!o)throw new r("Failed to extract Bard parameters",e.ErrorCode.UNAUTHORIZED);return{atValue:a,blValue:o}}catch(t){throw new r("Failed to initialize Bard session",e.ErrorCode.UNAUTHORIZED)}}parseBardResponse(t){try{const e=t.split("\n").find((e=>e.startsWith("[")));if(!e)throw new Error("Invalid response format");const r=JSON.parse(e),a=JSON.parse(r[0][2]);if(!a)throw new Error("Empty response data");const o=a[4][0][1][0],s=[a[1][0],a[1][1],a[4][0][0]],n=a[4][0][4]||[];let i=o;for(const e of n){const[t,r,a]=e;i=i.replace(a,`[![${t[4]}](${t[0][0]})](${r[0][0]})`)}return{text:i,ids:s}}catch(t){throw console.error("Error parsing Bard response:",t),new r("Failed to parse Bard response",e.ErrorCode.UNKNOWN_ERROR)}}async uploadImage(t){const a={"content-type":"application/x-www-form-urlencoded;charset=UTF-8","push-id":"feeds/mcudyrk2a4khkz","x-goog-upload-header-content-length":t.size.toString(),"x-goog-upload-protocol":"resumable","x-tenant-id":"bard-storage"},o=(await ne.raw("https://content-push.googleapis.com/upload/",{method:"POST",headers:{...a,"x-goog-upload-command":"start"},body:new URLSearchParams({[`File name: ${t.name}`]:""})})).headers.get("x-goog-upload-url");if(!o)throw new r("Failed to upload image",e.ErrorCode.UNKNOWN_ERROR);return await ne(o,{method:"POST",headers:{...a,"x-goog-upload-command":"upload, finalize","x-goog-upload-offset":"0"},body:t})}async ensureThreadLoaded(){if(!this.currentThread){const e=(await this.getAllThreads()).filter((e=>e.modelName===this.getName()&&this.isValidBardMetadata(e.metadata)));if(e.length>0){const t=e.sort(((e,t)=>t.updatedAt-e.updatedAt))[0];this.currentThread=t,console.log("Loaded existing thread from storage:",this.currentThread.id)}else await this.initNewThread()}}async doSendMessage(t){try{t.onEvent({type:"UPDATE_ANSWER",data:{text:""}}),await this.ensureThreadLoaded();const e=this.getCurrentThreadSafe(),r=this.createMessage("user",t.prompt);e.messages.push(r);const a=this.getBardMetadata();let o;console.log("Current context IDs before request:",a.contextIds),t.image&&(o=await this.uploadImage(t.image));const s=[null,JSON.stringify([[t.prompt,0,null,o?[[[o,1],t.image.name]]:[]],null,a.contextIds])],n=this.models[t.model||this.defaultModel],i=await ne("https://gemini.google.com/_/BardChatUi/data/assistant.lamda.BardFrontendService/StreamGenerate",{method:"POST",signal:t.signal,query:{bl:a.requestParams.blValue,_reqid:Math.floor(9e5*Math.random())+1e5,rt:"c"},body:new URLSearchParams({at:a.requestParams.atValue,"f.req":JSON.stringify(s)}),headers:n,parseResponse:e=>e}),{text:d,ids:l}=this.parseBardResponse(i),c=this.createMessage("assistant",d);c.metadata={messageId:l[0]},e.messages.push(c),e.metadata&&(e.metadata.contextIds=l),e.updatedAt=Date.now(),await this.saveThread(),t.onEvent({type:"UPDATE_ANSWER",data:{text:d}}),t.onEvent({type:"DONE",data:{threadId:l[1]}})}catch(a){throw t.onEvent({type:"ERROR",error:a instanceof r?a:new r(a instanceof Error?a.message:String(a),e.ErrorCode.NETWORK_ERROR)}),a}}async loadThread(e){const t=await this.getAllThreads(),r=t.find((t=>t.id===e));if(r&&r.modelName===this.getName()){this.currentThread=r;this.currentThread.metadata.requestParams=await this.fetchRequestParams(),await this.saveThread(),await this.saveThreadsToStorage(t)}}getBardMetadata(){const t=this.getCurrentThreadSafe();if(!t.metadata)throw new r("No thread metadata available",e.ErrorCode.INVALID_REQUEST);const a=t.metadata;if(!a.contextIds||!a.requestParams)throw new r("Invalid thread metadata",e.ErrorCode.INVALID_REQUEST);return a}getCurrentThreadSafe(){if(!this.currentThread)throw new r("No active thread",e.ErrorCode.INVALID_REQUEST);return this.currentThread}async initNewThread(){this.currentThread={id:g(),title:"New Conversation",messages:[],createdAt:Date.now(),updatedAt:Date.now(),modelName:this.getName(),metadata:{contextIds:["","",""],requestParams:await this.fetchRequestParams()}},await this.saveThread()}async saveThread(){if(!this.currentThread)return;const e=await this.getAllThreads(),t=e.findIndex((e=>e.id===this.currentThread.id));-1!==t?e[t]=this.currentThread:e.push(this.currentThread),await this.saveThreadsToStorage(e)}},e.BingModel=class extends h{constructor(){super(),this.baseUrl="https://copilot.microsoft.com",this.initializeStorage().catch(console.error)}async initializeStorage(){(await this.getAllThreads()).length||await this.saveThreadsToStorage([]),await this.validateExistingThreads()}async validateExistingThreads(){const e=await this.getAllThreads();let t=!1;for(const r of e)r.modelName!==this.getName()||this.isValidBingMetadata(r.metadata)||(await this.deleteThread(r.id),t=!0);t&&await this.saveThreadsToStorage(e.filter((e=>e.modelName!==this.getName()||this.isValidBingMetadata(e.metadata))))}isValidBingMetadata(e){return e?.conversationId}getName(){return"Bing Copilot"}supportsImageInput(){return!0}async createConversation(){try{if(!await ce(`${this.baseUrl}/`))throw new r(`Missing ${this.baseUrl} permission`,e.ErrorCode.MISSING_HOST_PERMISSION);const t=await f();if(!t)throw new r("Failed to get authorization token",e.ErrorCode.UNAUTHORIZED);const a=await fetch(`${this.baseUrl}/c/api/start`,{method:"POST",headers:{accept:"*/*","content-type":"application/json",authorization:`Bearer ${t}`},body:JSON.stringify({timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone,startNewConversation:!0}),credentials:"same-origin"});if(!a.ok){if(401===a.status){console.log("Token expired, refreshing...");if(await f(!0))return this.createConversation()}throw new r(`Failed to create conversation: ${a.status}`,e.ErrorCode.SERVICE_UNAVAILABLE)}const o=await a.json();if(console.log("Copilot create conversation response:",o),!o.currentConversationId)throw new r("Failed to create Copilot conversation",e.ErrorCode.SERVICE_UNAVAILABLE);return{conversationId:o.currentConversationId}}catch(t){throw console.error("Error initializing Copilot session:",t),new r("Failed to initialize Copilot session",e.ErrorCode.UNAUTHORIZED)}}async doSendMessage(t){let a=null,o=null;try{if(!await ce(`wss://${new URL(this.baseUrl).hostname}/`))throw new r(`Missing ${this.baseUrl} permission`,e.ErrorCode.MISSING_HOST_PERMISSION);console.log("Full params received in doSendMessage:",JSON.stringify({prompt:t.prompt,hasImage:!!t.image,hasSignal:!!t.signal,hasOnEvent:!!t.onEvent,mode:t.mode})),console.log("Received mode:",t.mode);let s="chat";t.mode?"chat"===t.mode||"reasoning"===t.mode?(s=t.mode,console.log("Using validated mode:",s)):console.warn(`Invalid mode "${t.mode}" provided. Using default mode "chat" instead.`):console.log('No mode provided, using default "chat" mode'),t.onEvent({type:"UPDATE_ANSWER",data:{text:""}}),await this.ensureThreadLoaded();const n=this.getCurrentThreadSafe(),i=this.createMessage("user",t.prompt);if(t.image){const e=await new Promise((e=>{const r=new FileReader;r.onload=t=>e(t.target?.result),r.readAsDataURL(t.image)}));i.metadata={...i.metadata,imageDataUrl:e}}n.messages.push(i),await this.saveThread();const d=await this.getBingMetadata();let l,c;if(t.image)try{l=await this.uploadImage(t.image),c=this.baseUrl+l,console.log("Image uploaded successfully:",c),i.metadata={...i.metadata,fullUrl:c},await this.saveThread()}catch(t){throw console.error("Error uploading image:",t),new r("Failed to upload image",e.ErrorCode.UNKNOWN_ERROR)}let g="",h=[],m=!1,u=!1;const p=n.messages.length<=1;let A=!p;const E=await f();if(!E)throw new r("No Copilot auth token found",e.ErrorCode.UNAUTHORIZED);a=new le(`wss://${new URL(this.baseUrl).hostname}/c/api/chat?api-version=2&accessToken=${E}`);const w=setTimeout((()=>{a&&a.readyState!==le.OPEN&&(console.error("WebSocket connection timeout"),t.onEvent({type:"ERROR",error:new r("Connection timeout",e.ErrorCode.NETWORK_ERROR)}),a.close())}),7e3),y=()=>{if(o&&(clearTimeout(o),o=null),a&&(a.readyState===le.OPEN||a.readyState===le.CONNECTING)){console.log("Safely closing WebSocket connection");try{a.close()}catch(e){console.error("Error closing WebSocket:",e)}}a=null},T=()=>{m&&(A&&u||!o)&&y()};a.onopen=()=>{console.log("WebSocket connection opened"),clearTimeout(w);try{const e=[];l&&e.push({type:"image",url:l}),e.push({type:"text",text:t.prompt});const r={event:"send",mode:s,conversationId:d.conversationId,content:e};console.log("Sending message:",JSON.stringify(r)),a.send(JSON.stringify(r))}catch(a){console.error("Error sending message:",a),t.onEvent({type:"ERROR",error:new r("Failed to send message",e.ErrorCode.NETWORK_ERROR)}),y()}},a.onmessage=e=>{try{const r=JSON.parse(e.data);if(console.log("WebSocket message:",r),"received"===r.event)console.log("Message received by server:",r.messageId);else if("startMessage"===r.event)console.log("Assistant starting response:",r.messageId);else if("appendText"===r.event)g+=r.text||"",t.onEvent({type:"UPDATE_ANSWER",data:{text:g}});else if("done"===r.event){const e=this.createMessage("assistant",g);n.messages.push(e),n.updatedAt=Date.now(),this.saveThread(),t.onEvent({type:"DONE",data:{threadId:n.id}}),m=!0,o=setTimeout((()=>{console.log("Closing connection after timeout - did not receive all expected events"),y()}),5e3)}else if("suggestedFollowups"===r.event&&r.suggestions){if(h=r.suggestions.map((e=>e)),n.messages.length>0){const e=n.messages[n.messages.length-1];"assistant"===e.role&&(e.metadata={suggestedResponses:h},this.saveThread(),t.onEvent({type:"SUGGESTED_RESPONSES",data:{suggestions:h}}))}u=!0,T()}else p&&"titleUpdate"===r.event&&r.title&&(console.log("Received title update:",r.title),n.title=r.title,this.saveThread(),t.onEvent({type:"TITLE_UPDATE",data:{title:r.title,threadId:n.id}}),A=!0,T())}catch(e){console.error("Error parsing Copilot response:",e)}},a.onerror=a=>{console.error("WebSocket error:",a),t.onEvent({type:"ERROR",error:new r("WebSocket connection error",e.ErrorCode.NETWORK_ERROR)}),y()},a.onclose=a=>{console.log(`WebSocket connection closed with code ${a.code}`,a.reason),clearTimeout(w),o&&(clearTimeout(o),o=null),m||t.onEvent({type:"ERROR",error:new r(`Connection closed unexpectedly (${a.code})`,e.ErrorCode.NETWORK_ERROR)})},t.signal&&t.signal.addEventListener("abort",(()=>{console.log("Request aborted by user"),y()}))}catch(s){if(o&&clearTimeout(o),a)try{a.close()}catch(e){console.error("Error closing WebSocket during error handling:",e)}throw t.onEvent({type:"ERROR",error:s instanceof r?s:new r(s instanceof Error?s.message:String(s),e.ErrorCode.NETWORK_ERROR)}),s}}async ensureThreadLoaded(){if(!this.currentThread){const e=(await this.getAllThreads()).filter((e=>e.modelName===this.getName()&&this.isValidBingMetadata(e.metadata)));if(e.length>0){const t=e.sort(((e,t)=>t.updatedAt-e.updatedAt))[0];this.currentThread=t,console.log("Loaded existing thread from storage:",this.currentThread.id)}else await this.initNewThread()}}getCurrentThreadSafe(){if(!this.currentThread)throw new r("No active thread",e.ErrorCode.INVALID_REQUEST);return this.currentThread}async initNewThread(){const e=await this.createConversation();this.currentThread={id:g(),title:"New Conversation",messages:[],createdAt:Date.now(),updatedAt:Date.now(),modelName:this.getName(),metadata:e},await this.saveThread()}async loadThread(e){const t=(await this.getAllThreads()).find((t=>t.id===e));if(!t||t.modelName!==this.getName())throw new Error("Thread not found");this.currentThread=t,await this.saveThread()}async getBingMetadata(){const t=this.getCurrentThreadSafe();if(!t.metadata)throw new r("No thread metadata available",e.ErrorCode.INVALID_REQUEST);const a=t.metadata;return this.isValidBingMetadata(a)?a:await this.createConversation()}async saveThread(){if(!this.currentThread)throw new r("No active thread",e.ErrorCode.INVALID_REQUEST);await super.saveThread()}async uploadImage(t){try{if(!await ce(`${this.baseUrl}/`))throw new r(`Missing ${this.baseUrl} permission`,e.ErrorCode.MISSING_HOST_PERMISSION);const a=await f(),o=await t.arrayBuffer();let s="image/jpeg";if(t.type)s=t.type;else{const e=t.name.toLowerCase();e.endsWith(".png")?s="image/png":e.endsWith(".gif")?s="image/gif":e.endsWith(".webp")?s="image/webp":e.endsWith(".bmp")?s="image/bmp":e.endsWith(".svg")&&(s="image/svg+xml")}const n={"content-type":s};a&&(n.authorization=`Bearer ${a}`);const i=await fetch(`${this.baseUrl}/c/api/attachments`,{method:"POST",headers:n,body:new Blob([o],{type:s}),credentials:"include",mode:"cors"});if(!i.ok){console.error("Image upload failed with status:",i.status);const t=await i.text();throw console.error("Error response:",t),new r(`Failed to upload image: ${i.status}`,e.ErrorCode.SERVICE_UNAVAILABLE)}const d=await i.json();if(console.log("Image upload response:",d),!d.url)throw new r("Invalid image upload response",e.ErrorCode.SERVICE_UNAVAILABLE);return d.url}catch(t){throw console.error("Error uploading image:",t),new r("Failed to upload image to Copilot",e.ErrorCode.UNKNOWN_ERROR)}}},e.ClaudeWebModel=ue,e.clearAuthCache=function(e){e?delete u[e]:Object.keys(u).forEach((e=>{delete u[e]}))},e.configureAuth=function(e){void 0!==e.notifyTokenRefresh&&(A=e.notifyTokenRefresh)},e.file2base64=function(e,t=!1){return new Promise(((r,a)=>{const o=new FileReader;o.readAsDataURL(e),o.onload=()=>{const e=o.result;r(t?e:e.split(",")[1])},o.onerror=a}))},e.getCookiesForDomain=async function(e){try{const t=await s.cookies.getAll({domain:e}),r={};for(const e of t)r[e.name]=e.value;return r}catch(t){return console.error(`Error getting cookies for ${e}:`,t),{}}},e.getCopilotAuth=f,e.getTokenExpiryTime=function(e){return u[e]&&u[e].expiresAt?Math.max(0,u[e].expiresAt-Date.now()):0},e.isTokenExpiringSoon=function(e){return!u[e]||!u[e].expiresAt||u[e].expiresAt<=Date.now()+p},e.parseSSEResponse=async function(e,t){const r=e.body.getReader(),a=new TextDecoder;let o="";for(;;){const{done:e,value:s}=await r.read();if(e)break;o+=a.decode(s,{stream:!0});const n=o.split("\n");o=n.pop()||"";for(const e of n){const r=e.trim();if(r&&r.startsWith("data: ")){t(r.slice(6))}}}if(o.trim()&&o.startsWith("data: ")){t(o.slice(6))}},e.streamAsyncIterable=async function*(e){const t=e.getReader();try{for(;;){const{done:e,value:r}=await t.read();if(e)return;yield r}}finally{t.releaseLock()}},e}({});
